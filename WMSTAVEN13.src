#<AdxTL>@(#)0.0.0.0 $Revision$
# Sage X3 supervisor
# Statistical Update VEN13

Subprog MAJSTA(SIGN)
Value Integer SIGN

Local Char    CRIT1(20) , CRIT2(20) , CRIT3(20) , CRIT4(20)
Local Char    CRIT5(20) , CRIT6(20) , CRIT7(20) , CRIT8(20)
Local Char    SOCIETE(GLONCPY) , SITE(GLONFCY) , VALPAR(10)
Local Char    INTIT(50)(1..8)
Local Date    DAT
Local Decimal MONTANT(1..10)
Local Integer ISITE , ISOC , STAT , COURTYP

Gosub OUVRE

SITE    = [F:SID]SALFCY
ISITE   = find(SITE,GSITE(1..GNBSITE))
If !ISITE : End : Endif
SOCIETE = GSOCSITE(ISITE)
ISOC    = find(SOCIETE,GSOC(1..GNBSOC))
If !ISOC : End : Endif
SITE    = ""

Gosub LIENS

If !([F:SIV]INVSTA=3)
 End
Endif
If !([F:SIH]INVTYP=1 & [F:SIV]STOMVTFLG=2 & [F:SIV]SIHORI=1)
 End
Endif

Raz CRIT1 , CRIT2 , CRIT3 , CRIT4 , CRIT5 , CRIT6 , CRIT7 , CRIT8
CRIT1 = mid$([F:ITM]TSICOD,1,3)
CRIT2 = mid$([F:ITM]ITMREF,1,20)
CRIT3 = mid$([F:BPC]TSCCOD,1,3)
CRIT4 = mid$([F:BPC]BPCNUM,1,10)
CRIT5 = "$$$"
CRIT6 = "$$$"
CRIT7 = "$$$"
CRIT8 = "$$$"

Read [ADI]CODE = 0+20;[F:ITM]TSICOD(0)
If fstat
 INTIT(1) = mess(167,123,1) : # Divers
Else
 Read [AXX]AXX0 = "ATABDIV";"LNGDES";GLANGUE;num$([F:ADI]NUMTAB);num$([F:ADI]CODE)
 If fstat
  INTIT(1) = mess(167,123,1) : # Divers
 Else
  INTIT(1) = [F:AXX]TEXTE
 Endif
Endif
Read [AXX]AXX0 = "ITMMASTER";"DES1AXX";GLANGUE;num$([F:ITM]ITMREF)
If fstat
 INTIT(2) = mess(167,123,1) : # Divers
Else
 INTIT(2) = [F:AXX]TEXTE
Endif
Read [ADI]CODE = 0+30;[F:BPC]TSCCOD(0)
If fstat
 INTIT(3) = mess(167,123,1) : # Divers
Else
 Read [AXX]AXX0 = "ATABDIV";"LNGDES";GLANGUE;num$([F:ADI]NUMTAB);num$([F:ADI]CODE)
 If fstat
  INTIT(3) = mess(167,123,1) : # Divers
 Else
  INTIT(3) = [F:AXX]TEXTE
 Endif
Endif
Read [BPR]BPR0 = [F:BPC]BPCNUM
If fstat
 INTIT(4) = mess(167,123,1) : # Divers
Else
 INTIT(4) = [F:BPR]BPRNAM
Endif

If [F:SID]INVDAT=[0/0/0] : End : Endif
DAT = gdat$(1,month([F:SID]INVDAT),year([F:SID]INVDAT))

Raz MONTANT
MONTANT(1) = [F:SID]AMTNOTLIN*[F:SIH]SNS
MONTANT(2) = [F:SID]PFM*[F:SID]QTY*[F:SIH]SNS
MONTANT(3) = [F:SID]AMTATILIN*[F:SIH]SNS
MONTANT(4) = [F:SID]QTYSTU/[F:ITM]SSUSTUCOE
MONTANT(5) = 1

Gosub CONV_DEVISE

Call MAJSTA(SIGN,"VEN13",SOCIETE,SITE,CRIT1,CRIT2,CRIT3,CRIT4,CRIT5,CRIT6,CRIT7,CRIT8,
&           INTIT,DAT,MONTANT,4) From SUBPS2

End

$OUVRE
If clalev([F:SIV])=0 : Local File SINVOICEV [SIV] : Endif
If clalev([F:SIH])=0 : Local File SINVOICE [SIH] : Endif
If clalev([F:ITM])=0 : Local File ITMMASTER [ITM] : Endif
If clalev([F:ITS])=0 : Local File ITMSALES [ITS] : Endif
If clalev([F:REP])=0 : Local File SALESREP [REP] : Endif
If clalev([F:BPC])=0 : Local File BPCUSTOMER [BPC] : Endif
If clalev([F:BPR])=0 : Local File BPARTNER [BPR] : Endif
If clalev([F:CAL])=0 : Local File CPTANALIN [CAL] : Endif
If clalev([F:ADI])=0 : Local File ATABDIV [ADI] : Endif
If clalev([F:ADI])=0 : Local File ATABDIV [ADI] : Endif
If clalev([F:AXX])=0 : Local File ATEXTRA [AXX] : Endif
Return

$FERME
If clalev([F:SIV])>0 : Close Local File [SIV] : Endif
If clalev([F:SIH])>0 : Close Local File [SIH] : Endif
If clalev([F:ITM])>0 : Close Local File [ITM] : Endif
If clalev([F:ITS])>0 : Close Local File [ITS] : Endif
If clalev([F:REP])>0 : Close Local File [REP] : Endif
If clalev([F:BPC])>0 : Close Local File [BPC] : Endif
If clalev([F:BPR])>0 : Close Local File [BPR] : Endif
If clalev([F:CAL])>0 : Close Local File [CAL] : Endif
If clalev([F:ADI])>0 : Close Local File [ADI] : Endif
If clalev([F:ADI])>0 : Close Local File [ADI] : Endif
If clalev([F:SID])>0 : Close Local File [SID] : Endif
If clalev([F:AXX])>0 : Close Local File [AXX] : Endif
Return

$ZOOM
Raz [M]OBJBOU, OBJCLE, OBJSEC
If [M:STA1]NIVEAU=2
 Call TEXTE(2061,GBOUT7) From OBJDIV
 [M]OBJBOU = "ITM"
 [M]OBJCLE = [M:STA2]CLE(max(0,nolign-1))
 [M]OBJSEC = ""
Endif
If [M:STA1]NIVEAU=4
 Call TEXTE(1500,GBOUT7) From OBJDIV
 [M]OBJBOU = "BPR"
 [M]OBJCLE = [M:STA2]CLE(max(0,nolign-1))
 [M]OBJSEC = ""
Endif
Return

$LIENS
indice=0
If [F:SIV]NUM<>[F:SID]NUM
 Read [SIV]SIV0 = [F:SID]NUM
 If fstat : Raz [F:SIV] : Endif
Endif
If [F:SIH]NUM<>[F:SIV]NUM
 Read [SIH]SIH0 = [F:SIV]NUM
 If fstat : Raz [F:SIH] : Endif
Endif
If [F:ITM]ITMREF<>[F:SID]ITMREF
 Read [ITM]ITM0 = [F:SID]ITMREF
 If fstat : Raz [F:ITM] : Endif
Endif
If [F:ITS]ITMREF<>[F:ITM]ITMREF
 Read [ITS]ITS0 = [F:ITM]ITMREF
 If fstat : Raz [F:ITS] : Endif
Endif
If [F:REP]REPNUM<>[F:SID]REP1
 Read [REP]REP0 = [F:SID]REP1
 If fstat : Raz [F:REP] : Endif
Endif
If [F:BPC]BPCNUM<>[F:SIV]BPCINV
 Read [BPC]BPC0 = [F:SIV]BPCINV
 If fstat : Raz [F:BPC] : Endif
Endif
If [F:BPR]BPRNUM<>[F:BPC]BPCNUM
 Read [BPR]BPR0 = [F:BPC]BPCNUM
 If fstat : Raz [F:BPR] : Endif
Endif
If [F:CAL]ABRFIC<>"SID" | [F:CAL]VCRTYP<>0 | [F:CAL]VCRNUM<>[F:SID]NUM | [F:CAL]VCRLIN<>[F:SID]SIDLIN | [F:CAL]VCRSEQ<>0 | [F:CAL]CPLCLE<>"" | [F:CAL]ANALIG<>1
 Read [CAL]CAL0 = "SID";0;[F:SID]NUM;[F:SID]SIDLIN;0;"";1
 If fstat : Raz [F:CAL] : Endif
Endif
Return

$CONV_DEVISE
Call PARAML(SITE,"CHGTYP",VALPAR) From ADOVAL
COURTYP = val(VALPAR)
If COURTYP=0 : COURTYP = 1 : Endif
If dim(WVERMNTNBR)<0
 Global Char WVERMNTTAB(30)(1..300)
 Global Char WVERMNTKEY(30)
 Global Decimal WVERMNTDEC(1..300)
 Global Integer WVERMNTNBR
 WVERMNTNBR = 1
Endif
Local Integer WI
WVERMNTKEY =  [F:SIH]CUR
WVERMNTKEY += func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR")
WVERMNTKEY += GDEVSOC(ISOC)
WVERMNTKEY += num$(COURTYP)
WVERMNTKEY += num$([F:SID]INVDAT)
WVERMNTKEY += num$(MONTANT(1))
WI = find(WVERMNTKEY,WVERMNTTAB(1..WVERMNTNBR))
If WI
 MONTANT(1) = WVERMNTDEC(WI)
Else
 Call CONVERT([F:SIH]CUR,func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR"),GDEVSOC(ISOC),COURTYP,[F:SID]INVDAT,MONTANT(1),MONTANT(1),STAT) From TRTDEV
 WVERMNTDEC(WVERMNTNBR) = MONTANT(1)
 WVERMNTTAB(WVERMNTNBR) = WVERMNTKEY
 If WVERMNTNBR>=300
  WVERMNTNBR = 1
  Raz WVERMNTDEC , WVERMNTTAB
 Else
  WVERMNTNBR += 1
 Endif
Endif
WVERMNTKEY =  [F:SIH]CUR
WVERMNTKEY += func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR")
WVERMNTKEY += GDEVSOC(ISOC)
WVERMNTKEY += num$(COURTYP)
WVERMNTKEY += num$([F:SID]INVDAT)
WVERMNTKEY += num$(MONTANT(2))
WI = find(WVERMNTKEY,WVERMNTTAB(1..WVERMNTNBR))
If WI
 MONTANT(2) = WVERMNTDEC(WI)
Else
 Call CONVERT([F:SIH]CUR,func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR"),GDEVSOC(ISOC),COURTYP,[F:SID]INVDAT,MONTANT(2),MONTANT(2),STAT) From TRTDEV
 WVERMNTDEC(WVERMNTNBR) = MONTANT(2)
 WVERMNTTAB(WVERMNTNBR) = WVERMNTKEY
 If WVERMNTNBR>=300
  WVERMNTNBR = 1
  Raz WVERMNTDEC , WVERMNTTAB
 Else
  WVERMNTNBR += 1
 Endif
Endif
WVERMNTKEY =  [F:SIH]CUR
WVERMNTKEY += func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR")
WVERMNTKEY += GDEVSOC(ISOC)
WVERMNTKEY += num$(COURTYP)
WVERMNTKEY += num$([F:SID]INVDAT)
WVERMNTKEY += num$(MONTANT(3))
WI = find(WVERMNTKEY,WVERMNTTAB(1..WVERMNTNBR))
If WI
 MONTANT(3) = WVERMNTDEC(WI)
Else
 Call CONVERT([F:SIH]CUR,func TRTX2FNC_SYRA.GET_PARAM_CHAR(GACTX, CST_ALEVFOLD, GACTX.AFOLDER, "SYSCUR"),GDEVSOC(ISOC),COURTYP,[F:SID]INVDAT,MONTANT(3),MONTANT(3),STAT) From TRTDEV
 WVERMNTDEC(WVERMNTNBR) = MONTANT(3)
 WVERMNTTAB(WVERMNTNBR) = WVERMNTKEY
 If WVERMNTNBR>=300
  WVERMNTNBR = 1
  Raz WVERMNTDEC , WVERMNTTAB
 Else
  WVERMNTNBR += 1
 Endif
Endif
Return


