#<AdxTL>@(#)0.0.0.0 $Revision$
######################################################################################################################
# Script            : SPEYSETRUL                                                                                        #
# Creation date     : 19/11/2018                                                                                     #
# Version           : 1.0.0                                                                                          #
# Authors (Company) : Majid (Leverage)                                                                               #
# Module            : Land Development                                                                               #
# -------------------------------------------------------------------------------------------------------------------#
# Epic              : https://jira.leveragetech.com.au/browse/DFCX1-187                                              #
# Description       : Settlement Rule                                                                                #
#--------------------------------------------------------------------------------------------------------------------#
# Evolutions        :                                                                                                #
######################################################################################################################

# Mask management YSETRUL (Specific)
$ACTION
Case ACTION
  When "LIENS"          :   Gosub LIENS
  When Default
Endcase
Return


######################################################################################
$LIENS

# If Process = Recognition set Allow adjustment to No and disabled
If [M:YSTR]YSETPRC = 2    :   Diszo [M:YSTR]YALWADJ   : Endif
# If Value adjustment = Yes, then Calculation type will default to Fixed value and cannot be changed
If [M:YSTR]YALWADJ = 2    :   Diszo [M:YSTR]YCALTYP   : Endif

Return

######################################################################################
## Section automatically added (screen YSETRUL) 19/11/2018 10:15:15 (MAJID)
######################################################################################
Subprog AM_YRULTYPCOD(VALEUR)
Variable Char    VALEUR()

# Refresh the value of screen from Settlement rule type
If !clalev([F:YSRT2])         :     Local File YSETRULTYP [YSRT2]    :   Endif
Read [F:YSRT2]YSRT0 = VALEUR

[M:YSTR] = [F:YSRT2]
Affzo [M:YSTR]

End
######################################################################################

######################################################################################
## Section automatically added (screen YSETRUL) 19/11/2018 10:37:24 (MAJID)
######################################################################################
Subprog C_YVLDTO(VALEUR)
Variable Date    VALEUR

If VALEUR < [M:YSTR]YVLDFRM
  GMESSAGE = mess(30,6255,1)       # Valid to cannot be before valid from
  GERR = 1  : mkstat = 1
Endif

Call CHECK_DATE(VALEUR)

End

######################################################################################

######################################################################################
Subprog C_YLANDPUR(VALEUR)
Variable Char    VALEUR()

# Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, VALEUR, [M:YSTR]YPRECINCT, [M:YSTR]YSTAG, [M:YSTR]YLOT)
End

######################################################################################
Subprog C_YPRECINCT(VALEUR)
Variable Char    VALEUR()

# Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, VALEUR, [M:YSTR]YSTAG, [M:YSTR]YLOT)
End

######################################################################################
Subprog C_YSTAG(VALEUR)
Variable Char    VALEUR()

# Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, [M:YSTR]YPRECINCT, VALEUR, [M:YSTR]YLOT)
End

######################################################################################
Subprog C_YLOT(VALEUR)
Variable Char    VALEUR()

# Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, [M:YSTR]YPRECINCT, [M:YSTR]YSTAG, VALEUR)
End
######################################################################################

######################################################################################
Subprog C_YALWADJ(VALEUR)
Variable Integer VALEUR

# If Value adjustment = Yes, then Calculation type will default to Fixed value and cannot be changed
If VALEUR = 2
  [M:YSTR]YCALTYP = 1
  Diszo [M:YSTR]YCALTYP
Else
  Actzo [M:YSTR]YCALTYP
Endif

End


######################################################################################
Subprog C_YSETPRC(VALEUR)
Variable Integer VALEUR

#If Process = Recognition set Allow adjustment to No and disabled and If Process = Receipt set to Yes, enabled and user can change
If VALEUR = 2
  [M:YSTR]YALWADJ = 1
  Diszo [M:YSTR]YALWADJ
  Actzo [M:YSTR]YCALTYP
Else
  [M:YSTR]YALWADJ = 2
  [M:YSTR]YCALTYP = 1
  Actzo [M:YSTR]YALWADJ
  Diszo [M:YSTR]YCALTYP
Endif

End


######################################################################################

######################################################################################
## Section automatically added (screen YSETRUL) 23/11/2018 15:44:59 (MAJID)
######################################################################################
Subprog C_YVLDFRM(VALEUR)
Variable Date    VALEUR

Call CHECK_DATE(VALEUR)

End


######################################################################################

#------------------------------------------------------------------------------------#
# Check date does not have overlap with another Rule
Subprog CHECK_DATE(YDATE)
Value Date YDATE

If !clalev([F:YSTR2])        :   Local File YSETRUL [YSTR2]     :   Endif

Filter [F:YSTR2] Where YEST=[M:YSTR]YEST & YLANDPUR=[M:YSTR]YLANDPUR & YPRECINCT=[M:YSTR]YPRECINCT & YSTAG=[M:YSTR]YSTAG &
& YLOT=[M:YSTR]YLOT & YRULTYPCOD=[M:YSTR]YRULTYPCOD Order By YVLDFRM

For [F:YSTR2] Where YVLDFRM <= YDATE and YDATE <= YVLDTO
    GMESSAGE = mess(34,6255,1)    # There is an overlapt between date of rules
    GERR = 1
    mkstat = 2
Next

If clalev([F:YSTR2])        :   Close Local File [YSTR2]     :   Endif

End
#------------------------------------------------------------------------------------#

#------------------------------------------------------------------------------------#
# Activate/Deactivate Object selection field
Subprog OBJSEL_STA (YEST, YLANDPUR, YPRECINCT, YSTAG, YLOT)
Value Integer YEST
Value Char YLANDPUR, YPRECINCT, YSTAG, YLOT

If    YLANDPUR<>""  #YLANDPUR<>"" & YPRECINCT="" & YSTAG="" & YLOT=""
  Grizo [M:YSTR]YPRECINCT, YSTAG, YLOT
  Diszo [M:YSTR]YEST
  Actzo [M:YSTR]YLANDPUR
Endif

If YPRECINCT<>"" #YLANDPUR="" & YPRECINCT<>"" & YSTAG="" & YLOT=""
  Grizo [M:YSTR]YLANDPUR
  Diszo [M:YSTR]YEST
  Actzo [M:YSTR]YPRECINCT, YSTAG, YLOT
Endif

If YSTAG<>"" #YLANDPUR="" & YPRECINCT="" & YSTAG<>"" & YLOT=""
  Grizo [M:YSTR]YLANDPUR
  Diszo [M:YSTR]YEST, YPRECINCT
  Actzo [M:YSTR]YSTAG, YLOT
Endif

If YLOT<>""  #YLANDPUR="" & YPRECINCT="" & YSTAG="" & YLOT<>""
  Grizo [M:YSTR]YLANDPUR
  Diszo [M:YSTR]YEST, YPRECINCT, YSTAG
  Actzo [M:YSTR]YLOT
Endif

If YLANDPUR="" & YPRECINCT="" & YSTAG="" & YLOT=""
  Actzo [M:YSTR]YEST, YLANDPUR, YPRECINCT, YSTAG, YLOT
Endif


End
#------------------------------------------------------------------------------------#

######################################################################################
## Section automatically added (screen YSETRUL) 26/11/2018 17:20:03 (MAJID)
######################################################################################
Subprog AS_YFGST(VALEUR)
Variable Char    VALEUR()

  Call GST_CODE ([M:YSTR]YFFCY, [M:YSTR]YTFCY)
End


############################################################################################
# Pickup the GST code
Subprog GST_CODE(YFFCY, YTFCY)

Variable Char    VALEUR()

Local Char REQUEST(255)(0..3)
Local Shortint YSAMEGRP

# For IE, if From Company and To Company are in the same GST Group, set to NA and user cannot change.
REQUEST(0) = "Select count(g.CODGSTGRP_0) CNT from GSTGRPD g Inner join FACILITY f on f.LEGCPY_0=g.CPY_0 "
REQUEST(0) -= "and f.FCY_0='" + YFFCY + "' Where g.CODGSTGRP_0 in ("
REQUEST(1) = "Select g2.CODGSTGRP_0 from GSTGRPD g2 Inner join FACILITY f2 on f2.LEGCPY_0=g2.CPY_0 "
REQUEST(1) -= "and f2.FCY_0='" + YTFCY + "')"

For (Integer CNT) From "5" Sql REQUEST As [YLNK]
  YSAMEGRP = [YLNK]CNT
Next

If YSAMEGRP > 0     #   From and To Site/Company are belong to same compny
  [M:YSTR]YFGST = "N/A" : Affzo [M:YSTR]YFGST
  Diszo [M:YSTR]YFGST
Else

  Actzo [M:YSTR]YFGST
  # Default to Tax of Account code
  Local Char REQUEST(255)(0..3)
  REQUEST(0) = "Select a.VAT_0 From FACILITY f Inner join COMPANY c on f.LEGCPY_0=c.CPY_0 Inner join GACM m on c.ACM_0=m.GCM_0 "
  REQUEST(1) = "Inner join GLED l on m.LED_0=l.LED_0 Inner join GACCOUNT a on l.COA_0=a.COA_0 Where a.ENAFLG_0=2 "
  REQUEST(2) = "and f.FCY_0='" + YFFCY + "' and a.ACC_0='" + YFACC + "'"

  For (Char VAT(30)) From "5" Sql REQUEST As [YLNK]
    [M:YSTR]YFGST = [YLNK]VAT : Affzo [M:YSTR]YFGST
  Next

Endif

End


######################################################################################

######################################################################################
## Section automatically added (screen YSETRUL) 26/11/2018 18:22:34 (MAJID)
######################################################################################
Subprog AM_YFFCY(VALEUR)
Variable Char    VALEUR()

  Call GST_CODE (VALEUR, [M:YSTR]YTFCY)
End

Subprog AM_YTFCY(VALEUR)
Variable Char    VALEUR()

  Call GST_CODE ([M:YSTR]YFFCY, VALEUR)
End


######################################################################################

