#<AdxTL>@(#)0.0.0.0 $Revision$
######################################################################################################################
# Script            : SPEYSETRUL                                                                                     #
# Creation date     : 19/11/2018                                                                                     #
# Version           : 1.0.0                                                                                          #
# Authors (Company) : Majid (Leverage)                                                                               #
# Module            : Land Development                                                                               #
# -------------------------------------------------------------------------------------------------------------------#
# Epic              : https://jira.leveragetech.com.au/browse/DFCX1-187                                              #
# Description       : Settlement Rule                                                                                #
#--------------------------------------------------------------------------------------------------------------------#
# Evolutions        :                                                                                                #
######################################################################################################################

# Mask management YSETRUL (Specific)
$ACTION
Case ACTION
  When "LIENS"          :   Gosub LIENS
  When Default
Endcase
Return


######################################################################################
$LIENS

# Check the entry field statsu based on Settlement rule type
Call CHECK_ENTRY_FIELD ()

# If Process = Recognition set Allow adjustment to No and disabled
If [M:YSTR]YSETPRC = 2    :   Diszo [M:YSTR]YALWADJ   : Endif
# If Value adjustment = Yes, then Calculation type will default to Fixed value and cannot be changed
If [M:YSTR]YALWADJ = 2    :   Diszo [M:YSTR]YCALTYP   : Endif

Return
#------------------------------------------------------------------------------------#

######################################################################################
##
Subprog AM_YRULTYPCOD(VALEUR)
Variable Char    VALEUR()

# Refresh the value of screen from Settlement rule type
If !clalev([F:YSRT2])         :     Local File YSETRULTYP [YSRT2]    :   Endif
Read [F:YSRT2]YSRT0 = VALEUR

[M:YSTR] = [F:YSRT2]
If [M:YSTR]YVLDFRM = [0/0/0]  : [M:YSTR]YVLDFRM = date$   :   Endif

# Check the entry field statsu based on Settlement rule type
Call CHECK_ENTRY_FIELD

Affzo [M:YSTR]

End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YLANDPUR(VALEUR)
Variable Char    VALEUR()

  # Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, VALEUR, [M:YSTR]YPRECINCT, [M:YSTR]YSTAG, [M:YSTR]YLOT)

  # Check the Land purchase is under Estate
  Call C_YLNDPUR ([M:YSTR]YEST, VALEUR) From YSELLNDPUR

End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YPRECINCT(VALEUR)
Variable Char    VALEUR()

  # Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, VALEUR, [M:YSTR]YSTAG, [M:YSTR]YLOT)
End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YSTAG(VALEUR)
Variable Char    VALEUR()

  # Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, [M:YSTR]YPRECINCT, VALEUR, [M:YSTR]YLOT)
End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YLOT(VALEUR)
Variable Char    VALEUR()

  # Activate/Deactivat Object selection field
  Call OBJSEL_STA ([M:YSTR]YEST, [M:YSTR]YLANDPUR, [M:YSTR]YPRECINCT, [M:YSTR]YSTAG, VALEUR)
End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YALWADJ(VALEUR)
Variable Integer VALEUR

# If Value adjustment = Yes, then Calculation type will default to Fixed value and cannot be changed
If VALEUR = 2
  [M:YSTR]YCALTYP = 1
  Diszo [M:YSTR]YCALTYP
Else
  Actzo [M:YSTR]YCALTYP
Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog C_YSETPRC(VALEUR)
Variable Integer VALEUR

#If Process = Recognition set Allow adjustment to No and disabled and If Process = Receipt set to Yes, enabled and user can change
If VALEUR = 2
  [M:YSTR]YALWADJ = 1
  Diszo [M:YSTR]YALWADJ
  Actzo [M:YSTR]YCALTYP
Else
  [M:YSTR]YALWADJ = 2
  [M:YSTR]YCALTYP = 1
  Actzo [M:YSTR]YALWADJ
  Diszo [M:YSTR]YCALTYP
Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
## Control Valid from & To
Subprog C_YVLDFRM(VALEUR)
Variable Date    VALEUR

Call CHECK_DATE(VALEUR)

End

######################################################################################
Subprog C_YVLDTO(VALEUR)
Variable Date    VALEUR

If VALEUR < [M:YSTR]YVLDFRM
  GMESSAGE = mess(30,6255,1)       # Valid to cannot be before valid from
  GERR = 1  : mkstat = 1
Endif

Call CHECK_DATE(VALEUR)

End
#------------------------------------------------------------------------------------#


######################################################################################
# Check date does not have overlap with another Rule
Subprog CHECK_DATE(YDATE)
Value Date YDATE

If !clalev([F:YSTR2])        :   Local File YSETRUL [YSTR2]     :   Endif

Filter [F:YSTR2] Where YEST=[M:YSTR]YEST & YLANDPUR=[M:YSTR]YLANDPUR & YPRECINCT=[M:YSTR]YPRECINCT & YSTAG=[M:YSTR]YSTAG &
& YLOT=[M:YSTR]YLOT & YRULTYPCOD=[M:YSTR]YRULTYPCOD Order By YVLDFRM

For [F:YSTR2] Where YRULID<>[M:YSTR]YRULID and (YVLDFRM <= YDATE and YDATE <= YVLDTO)
    GMESSAGE = mess(35,6255,1) - [F:YSTR2]YRULID    # There is an overlapt between entered date and date of rule id:
    GERR = 1
    mkstat = 2
Next

If clalev([F:YSTR2])        :   Close Local File [YSTR2]     :   Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
# Activate/Deactivate Object selection field
Subprog OBJSEL_STA (YEST, YLANDPUR, YPRECINCT, YSTAG, YLOT)
Value Integer YEST
Value Char YLANDPUR, YPRECINCT, YSTAG, YLOT

  If    YLANDPUR<>""  #YLANDPUR<>"" & YPRECINCT="" & YSTAG="" & YLOT=""
    Grizo [M:YSTR]YPRECINCT, YSTAG, YLOT
    Diszo [M:YSTR]YEST
    Actzo [M:YSTR]YLANDPUR
  Endif

  If YPRECINCT<>"" #YLANDPUR="" & YPRECINCT<>"" & YSTAG="" & YLOT=""
    Grizo [M:YSTR]YLANDPUR
    Diszo [M:YSTR]YEST
    Actzo [M:YSTR]YPRECINCT, YSTAG, YLOT
  Endif

  If YSTAG<>"" #YLANDPUR="" & YPRECINCT="" & YSTAG<>"" & YLOT=""
    Grizo [M:YSTR]YLANDPUR
    Diszo [M:YSTR]YEST, YPRECINCT
    Actzo [M:YSTR]YSTAG, YLOT
  Endif

  If YLOT<>""  #YLANDPUR="" & YPRECINCT="" & YSTAG="" & YLOT<>""
    Grizo [M:YSTR]YLANDPUR
    Diszo [M:YSTR]YEST, YPRECINCT, YSTAG
    Actzo [M:YSTR]YLOT
  Endif

  If YLANDPUR="" & YPRECINCT="" & YSTAG="" & YLOT=""
    Actzo [M:YSTR]YEST, YLANDPUR, YPRECINCT, YSTAG, YLOT
  Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
## Before From GST
Subprog AS_YFGST(VALEUR)
Variable Char    VALEUR()

  Call UPD_GST4FCY ([M:YSTR]YFFCY, [M:YSTR]YTFCY)

End
#------------------------------------------------------------------------------------#

######################################################################################
##  Before To GST
Subprog AS_YTGST(VALEUR)
Variable Char    VALEUR()

  Call UPD_GST4FCY ([M:YSTR]YFFCY, [M:YSTR]YTFCY)

End
#------------------------------------------------------------------------------------#

######################################################################################
## After modification of From Site
Subprog AM_YFFCY(VALEUR)
Variable Char    VALEUR()

  # Update GST code
  Call UPD_GST4FCY (VALEUR, [M:YSTR]YTFCY)

  # Update dimension type for the site
  Call UPD_FCY_DIE_COA (VALEUR, 'F')

  # If Journal entry type = Journal then To site = From site and Disable
  If [F:GTE]YBUSBATTYP = 3
    [M:YSTR]YTFCY = VALEUR
    Diszo [M:YSTR]YTFCY
    Affzo [M:YSTR]YTFCY
  Endif
End
#------------------------------------------------------------------------------------#

######################################################################################
Subprog AM_YTFCY(VALEUR)
Variable Char    VALEUR()

  # Update GST code
  Call UPD_GST4FCY ([M:YSTR]YFFCY, VALEUR)

  # Update dimension type for the site
  Call UPD_FCY_DIE_COA (VALEUR, 'T')

End
#------------------------------------------------------------------------------------#


######################################################################################
##
Subprog C_YFPJTLIN(VALEUR)
Variable Char    VALEUR()

  # If Project Link is mandatory (Account is a Project Account) the Job will default from the Project link and display only
  Call UPD_CCE ([M:YSTR]YFCOA,[M:YSTR]YFACC, VALEUR, "F")

End

######################################################################################
Subprog C_YTPJTLIN(VALEUR)
Variable Char    VALEUR()

  # If Project Link is mandatory (Account is a Project Account) the Job will default from the Project link and display only
  Call UPD_CCE ([M:YSTR]YFCOA,[M:YSTR]YFACC, VALEUR, "T")

End
#------------------------------------------------------------------------------------#

######################################################################################
## Control From Account
Subprog C_YFACC(VALEUR)
Variable Char    VALEUR()
  # If Account is a Project Account then Project Link is Active/Mandatory else disabled
  If !clalev([F:YGAC])       : Local File GACCOUNT [YGAC]   :   Endif
  Read [F:YGAC]GAC0 = [M:YSTR]YFCOA;VALEUR

  If !fstat & [F:YGAC]YPJM=2
    Actzo [M:YSTR]YFPJTLIN
  Else
    [M:YSTR]YFPJTLIN = ""
    Diszo [M:YSTR]YFPJTLIN
  Endif

  # Each time user selects the account the project, job and job cost centre fields should be refreshed
  If [M:YSTR]YFACC <> VALEUR
    [M:YSTR]YFPJTLIN = ""
    [M:YSTR]YFCCE3 = ""
    [M:YSTR]YFCCE4 = ""
    Affzo [M:YSTR]YFPJTLIN, YFCCE3, YFCCE4
  Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
# Control To Account
Subprog C_YTACC(VALEUR)
Variable Char    VALEUR()

  # If Account is a Project Account then Project Link is Active/Mandatory else disabled
  If !clalev([F:YGAC])       : Local File GACCOUNT [YGAC]   :   Endif
  Read [F:YGAC]GAC0 = [M:YSTR]YTCOA;VALEUR
  If !fstat & [F:YGAC]YPJM=2
    Actzo [M:YSTR]YTPJTLIN
  Else
    [M:YSTR]YTPJTLIN = ""
    Diszo [M:YSTR]YTPJTLIN
  Endif

  # Each time user selects the account the project, job and job cost centre fields should be refreshed
  If [M:YSTR]YTACC <> VALEUR
    [M:YSTR]YTPJTLIN = ""
    [M:YSTR]YTCCE3 = ""
    [M:YSTR]YTCCE4 = ""
    Affzo [M:YSTR]YTPJTLIN, YTCCE3, YTCCE4
  Endif
End
#------------------------------------------------------------------------------------#

######################################################################################
##
Subprog C_YPRC(VALEUR)
Variable Decimal VALEUR

# Either percentage or fixed value field should be available
If VALEUR <> 0
  Diszo [M:YSTR]YFFXDVAL
Else
  Actzo [M:YSTR]YFFXDVAL
Endif

End
#------------------------------------------------------------------------------------#

Subprog C_YFFXDVAL(VALEUR)
Variable Decimal VALEUR

# Either percentage or fixed value field should be available
If VALEUR <> 0
  Diszo [M:YSTR]YPRC
Else
  Actzo [M:YSTR]YPRC
Endif

End
#------------------------------------------------------------------------------------#

######################################################################################
##
Subprog UPD_CCE (YCOA, YACC, YOPP, YTYP)
Value Char YCOA, YACC, YOPP, YTYP

Local Char YPRJNUM, YBUDCOD, YPCCCOD

If !clalev([F:YGAC])       : Local File GACCOUNT [YGAC]   :   Endif
Read [F:YGAC]GAC0 = YCOA;YACC
If !fstat & [F:YGAC]YPJM=2      #   Account is Project managed

  If !clalev([F:YOPPPJM])        :    Local File OPPORPJM [YOPPPJM]  :  Endif
  If !clalev([F:YPJLB])          :    Local File PJMBUDLIG [YPJLB]   :  Endif

  If instr(1,YOPP,'!')>0
    YPRJNUM =  left$(YOPP, instr(1,YOPP,'!')-1)
    YBUDCOD =  seg$(YOPP,instr(1,YOPP,"!")+2,len(YOPP))
    Read [F:YOPPPJM]OPPPJM0 = YPRJNUM
    For [F:YPJLB]PJLB0 Where OPPNUM=YPRJNUM and PBUCOD=YBUDCOD
      YPCCCOD = [F:YPJLB]PCCCOD
      Break
    Next
  Else
    Read [F:YOPPPJM]OPPPJM0 = YOPP
    For [F:YPJLB]PJLB0 Where OPPNUM=YOPP
      YPCCCOD = [F:YPJLB]PCCCOD         #   Cost type of Cost structure
      Break
    Next
  Endif

  If YTYP = "F"
    [M:YSTR]YFCCE3 = [F:YOPPPJM]CCE(2)
    [M:YSTR]YFCCE4 = YPCCCOD
    Diszo [M:YSTR]YFCCE3, YFCCE4
  Elsif YTYP = "T"
    [M:YSTR]YTCCE3 = [F:YOPPPJM]CCE(2)
    [M:YSTR]YTCCE4 = YPCCCOD
    Diszo [M:YSTR]YTCCE3, YTCCE4
  Endif
  Actzo [M:YSTR]YTCCE3, YTCCE4

Endif

End
#------------------------------------------------------------------------------------#

############################################################################################
# GST rules based on site
Subprog UPD_GST4FCY(YFFCY, YTFCY)
Value Char    YFFCY, YTFCY

Local Char REQUEST(255)(0..3)
Local Shortint YSAMEGRP

# For IE, if From Company and To Company are in the same GST Group, set to NA and user cannot change.
REQUEST(0) = "Select count(g.CODGSTGRP_0) CNT from GSTGRPD g Inner join FACILITY f on f.LEGCPY_0=g.CPY_0 "
REQUEST(0) -= "and f.FCY_0='" + YFFCY + "' Where g.CODGSTGRP_0 in ("
REQUEST(1) = "Select g2.CODGSTGRP_0 from GSTGRPD g2 Inner join FACILITY f2 on f2.LEGCPY_0=g2.CPY_0 "
REQUEST(1) -= "and f2.FCY_0='" + YTFCY + "')"

For (Integer CNT) From "5" Sql REQUEST As [YLNK]
  YSAMEGRP = [YLNK]CNT
Next

If YSAMEGRP > 0 & [F:GTE]YBUSBATTYP = 1     #   From and To Site/Company are belong to same compny
  [M:YSTR]YFGST = "N/A" : [M:YSTR]YTGST = "N/A"
  Diszo [M:YSTR]YFGST, YTGST
Else

  Actzo [M:YSTR]YFGST
  # Default to Tax of Account code
  Local Char REQUEST(255)(0..3)
  REQUEST(0) = "Select a.VAT_0 From FACILITY f Inner join COMPANY c on f.LEGCPY_0=c.CPY_0 Inner join GACM m on c.ACM_0=m.GCM_0 "
  REQUEST(1) = "Inner join GLED l on m.LED_0=l.LED_0 Inner join GACCOUNT a on l.COA_0=a.COA_0 Where a.ENAFLG_0=2 "
  REQUEST(2) = "and f.FCY_0='" + YFFCY + "' and a.ACC_0='" + YFACC + "'"

  For (Char VAT(30)) From "5" Sql REQUEST As [YLNK]
    [M:YSTR]YFGST = [YLNK]VAT
  Next

  Actzo [M:YSTR]YTGST
  # Default to Tax of Account code
  Local Char REQUEST(255)(0..3)
  REQUEST(0) = "Select a.VAT_0 From FACILITY f Inner join COMPANY c on f.LEGCPY_0=c.CPY_0 Inner join GACM m on c.ACM_0=m.GCM_0 "
  REQUEST(1) = "Inner join GLED l on m.LED_0=l.LED_0 Inner join GACCOUNT a on l.COA_0=a.COA_0 Where a.ENAFLG_0=2 "
  REQUEST(2) = "and f.FCY_0='" + YTFCY + "' and a.ACC_0='" + YTACC + "'"

  For (Char VAT(30)) From "5" Sql REQUEST As [YLNK]
    [M:YSTR]YTGST = [YLNK]VAT
  Next

Endif

Affzo [M:YSTR]YFGST, YTGST

End
#------------------------------------------------------------------------------------#

######################################################################################
# Update dimension type for the site
Subprog UPD_FCY_DIE_COA(YFCY, YFCYTYP)
Value Char YFCY(), YFCYTYP()

  If !clalev ([F:YFCY])         :     Local File FACILITY [YFCY]    :   Endif
  If !clalev ([F:YCPY])         :     Local File COMPANY [YCPY]    :   Endif
  Read [F:YFCY]FCY0 = YFCY
  Read [F:YCPY]CPY0 = [F:YFCY]LEGCPY
  If YFCYTYP = 'F'
    [M:YSTR]YFDIE1 = [F:YCPY]DIE(0)
    [M:YSTR]YFDIE2 = [F:YCPY]DIE(1)
    [M:YSTR]YFDIE3 = [F:YCPY]DIE(2)
    [M:YSTR]YFDIE4 = [F:YCPY]DIE(3)
    [M:YSTR]YFDIE5 = [F:YCPY]DIE(4)
    [M:YSTR]YFDIE6 = [F:YCPY]DIE(5)
    [M:YSTR]YFDIE7 = [F:YCPY]DIE(6)
    [M:YSTR]YFDIE8 = [F:YCPY]DIE(7)
    [M:YSTR]YFDIE9 = [F:YCPY]DIE(8)
  Elsif YFCYTYP = 'T'
    [M:YSTR]YTDIE1 = [F:YCPY]DIE(0)
    [M:YSTR]YTDIE2 = [F:YCPY]DIE(1)
    [M:YSTR]YTDIE3 = [F:YCPY]DIE(2)
    [M:YSTR]YTDIE4 = [F:YCPY]DIE(3)
    [M:YSTR]YTDIE5 = [F:YCPY]DIE(4)
    [M:YSTR]YTDIE6 = [F:YCPY]DIE(5)
    [M:YSTR]YTDIE7 = [F:YCPY]DIE(6)
    [M:YSTR]YTDIE8 = [F:YCPY]DIE(7)
    [M:YSTR]YTDIE9 = [F:YCPY]DIE(8)
  Endif

# Update COA

  Local Char REQUEST(255)(0..3)

  Actzo [M:YSTR]YFGST
  # Default to Tax of Account code
  Local Char REQUEST(255)(0..3)
  REQUEST(0) = "Select l.COA_0 From FACILITY f Inner join COMPANY c on f.LEGCPY_0=c.CPY_0 Inner join GACM m on c.ACM_0=m.GCM_0 "
  REQUEST(1) = "Inner join GLED l on m.LED_0=l.LED_0 and f.FCY_0='" + YFCY + "'"

  For (Char COA(30)) From "5" Sql REQUEST As [YLNK]
    If YFCYTYP = 'F'
      [M:YSTR]YFCOA = [YLNK]COA
    Elsif YFCYTYP = 'T'
      [M:YSTR]YTCOA = [YLNK]COA
    Endif
  Next

End
#------------------------------------------------------------------------------------#



#------------------------------------------------------------------------------------#
# Activate or deactivate of fields based on Settlement rule type
#------------------------------------------------------------------------------------#
Subprog CHECK_ENTRY_FIELD ()
# If the Settlement Rule Journal /Entry Type is Cash, then Bank is available and mandatory.
If [F:GTE]TYP <> [M:YSTR]YENTTYP  : Read [F:GTE]GTE0 = [M:YSTR]YENTTYP;"AUS"  : Endif
If [F:JOU]JOU <> [M:YSTR]YJOU     : Read [F:JOU]JOU0 = [M:YSTR]YJOU;"AUS"     : Endif

If [F:GTE]YBUSBATTYP = 2 or [F:JOU]YBUSBATTYP = 2
  Actzo [M:YSTR]YFBANK
Else
  Diszo [M:YSTR]YFBANK
Endif

#Where Settlement Rule - Entry Type is Inter-Entity then ELA is Available and optional otherwise disabled
If [F:GTE]YBUSBATTYP = 1
  Actzo [M:YSTR]YFLONAGR
Else
  Diszo [M:YSTR]YFLONAGR
Endif

# If Account is a Project Account then Project Link is Active/Mandatory else disabled
If !clalev([F:YGAC])       : Local File GACCOUNT [YGAC]   :   Endif
Read [F:YGAC]GAC0 = [M:YSTR]YFCOA;[M:YSTR]YFACC
If !fstat & [F:YGAC]YPJM=2
  Actzo [M:YSTR]YFPJTLIN
Else
  Diszo [M:YSTR]YFPJTLIN
Endif

Read [F:YGAC]GAC0 = [M:YSTR]YTCOA;[M:YSTR]YTACC
If !fstat & [F:YGAC]YPJM=2
  Actzo [M:YSTR]YTPJTLIN
Else
  Diszo [M:YSTR]YTPJTLIN
Endif

# Process = Recognition then Deactive Adjustment (this rules comes from Settlement rule type spec)
If [M:YSTR]YSETPRC = 2 : Diszo [M:YSTR]YALWADJ : Else  Actzo [M:YSTR]YALWADJ : Endif

# Percentage and Fixed value not available if Adjustment = Yes
If [M:YSTR]YALWADJ = 2 : Diszo [M:YSTR]YCALTYP : Else  Actzo [M:YSTR]YCALTYP : Endif

# Rules for the Fields on "To" section
If [F:GTE]YBUSBATTYP = 1      # Inter-entity
  Actzo [M:YSTR]YTFCY, YTACC, YTGST, YTAMTAMD, YTLONLGR, YTPJTLIN, YTCCE1, YTCCE2, YTCCE3, YTCCE4, YTCCE5
Elsif [F:GTE]YBUSBATTYP = 2   # Cash
  Diszo [M:YSTR]YTFCY, YTACC, YTGST, YTAMTAMD, YTLONLGR, YTPJTLIN, YTCCE1, YTCCE2, YTCCE3, YTCCE4, YTCCE5
Elsif [F:GTE]YBUSBATTYP = 3   # Journal
  Actzo [M:YSTR]YTACC, YTGST, YTAMTAMD, YTPJTLIN, YTCCE1, YTCCE2, YTCCE3, YTCCE4, YTCCE5
  Diszo [M:YSTR]YTFCY, YTLONLGR
Endif

End
#------------------------------------------------------------------------------------#

