#<AdxTL>@(#)0.0.0.0 $Revision$ Supplier BP invoice
#------------------------------------------------------------------------------------#
#Action
#------------------------------------------------------------------------------------#
$ACTION
#Infbox ACTION
Case ACTION
 When "OUVRE" : Gosub OUVRE
 When "INICRE" : Gosub INICRE
 When "VERIF_MOD" : Gosub VERIF_MOD
 When "VERIF_CRE" : Gosub VERIF_CRE
 When "STYLE"     : Gosub STYLE
 When "SETBOUT"     : Gosub SETBOUT
 When "LIENS"     : Gosub LIENS
 When "AVANT_CHOI" : Gosub AVANT_CHOI
 When Default
Endcase
Return


$AVANT_CHOI

If YUPDBUD = 2
  mkstat = 4
  Gosub ENTRE_MODIF From GOBJSUB
  Gosub SETBOUT From GOBJSUB
Endif

Return

$LIENS
Local Integer YUPDBUD : YUPDBUD = 1
If !GWEBSERV



Gosub LIENS From SUBBIS

#reload the budget values incase the budget was updated.
Local Char YPRJNUM,YBUDCOD
Local Decimal YBUDAMT

  # see if any of the lines entered is over budget.

#clear the status
[M:BIS1]YOVRBUD = 1
Affzo [M:BIS1]YOVRBUD


#Infbox num$([M:BIS3]NBLIG)

  For I = 0 To [M:BIS3]NBLIG-1

  Filter [F:YGAC] Where ACC = [M:BIS3]ACC1(I)
  For [F:YGAC]
  If [F:YGAC]YPJM = 2

    If (instr(1,[M:BIS3]PJTLIN(I),"!")) <= 0
     # Errbox "Project and budget codes could not be determined. Please ensure that a project and budget code was entered."

      [M:BIS1]YOVRBUD = 2
      Affzo [M:BIS1]YOVRBUD

      If GWEBSERV
        GYOK = 0
      Endif
      Break
    Endif

    #get the project and budget code

    YPRJNUM =  seg$([M:BIS3]PJTLIN(I),1,instr(1,[M:BIS3]PJTLIN(I),"!")-1)
    YBUDCOD =  seg$([M:BIS3]PJTLIN(I),instr(1,[M:BIS3]PJTLIN(I),"!")+2,len([M:BIS3]PJTLIN(I)))

    #get the latest budget amount.
    Filter [F:YPJB]
    Filter [F:YPJB] Where OPPNUM = YPRJNUM and PBUCOD = YBUDCOD and PLBFCY = [M:BIS0]FCY
    Read [F:YPJB] First
#Infbox num$([M:BIS3]YBUDAMT(I)),num$([F:YPJB]PLBAMT),num$([M:BIS1]STA)
    If ([M:BIS3]YBUDAMT(I) <> [F:YPJB]PLBAMT) & [M:BIS1]STA = 2
#    Infbox num$([M:BIS3]YBUDAMT(I)),num$([F:YPJB]PLBAMT),num$([M:BIS1]STA)
      Infbox "Budgets updated on line: " + num$(I+1)
      YUPDBUD = 2
    Endif

    [M:BIS3]YBUDAMT(I) = [F:YPJB]PLBAMT

    Affzo [M:BIS3]YBUDAMT(I)

    Local Decimal YAPPERC
    Local Decimal YAPAMT

    # get the AP Tollorance and Amount
    Read[F:YCPY]CPY0 = [M:BIS0]CPY
    If fstat = 0
      YAPPERC = [F:YCPY]YAPTPCT
      YAPAMT  = [F:YCPY]YAPTAMT
    Endif
  #
  #    #get the amount remaining.
      Local Char ZSQL(255)(3)
      Local Decimal YSPENT
      Local Decimal YTOLAMT
      ZSQL(0) = "SELECT SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
      ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + [M:BIS3]PJTLIN(I) + "'"# AND H.STA_0 = 2"
  #
      For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]

        [M:BIS3]YALLOCAMT(I) = [F:YLNK]YAMT
        Affzo [M:BIS3]YALLOCAMT(I)

        If ([M:BIS3]YBUDAMT(I) * (1+YAPPERC)) > ([M:BIS3]YBUDAMT(I) +YAPAMT)
          [M:BIS3]YBUDAMT(I) = ([M:BIS3]YBUDAMT(I) +YAPAMT)
        Else
          [M:BIS3]YBUDAMT(I) = ([M:BIS3]YBUDAMT(I) * (1+YAPPERC))
        Endif
        Affzo [M:BIS3]YBUDAMT(I)


        [M:BIS3]YRMNAMT(I) = [M:BIS3]YBUDAMT(I) - [M:BIS3]YALLOCAMT(I)
        Affzo [M:BIS3]YRMNAMT(I)



        If [M:BIS3]AMTNOTLIN(I) > [M:BIS3]YRMNAMT(I)
          If !GWEBSERV
            #Errbox "The invoice amount before tax is more than the remaining budgeted amount on line number: " + num$(I + 1)
            #GERR = 1
          Endif
          [M:BIS1]YOVRBUD = 2
          Affzo [M:BIS1]YOVRBUD

  #        If GWEBSERV
  #          GYOK = 0
  #        Endif

        Endif


     Next
    Endif
    Next

  Next
Filter [F:YGAC]

GPE=1

#-------------------------------------------------------
  #Gosub VALBUD
#DEWALD - TEST for FAT00 - If this displays, fix was not made in DEV00 - Repatch Immediatly.
  #If [M:BIS1]YOVRBUD = 2
  #  GMESSAGE = "The project's budget is exceeded. Posting of the invoice is disabled. Please correct the budget or invoice."
  #  GERR = 1
  #Endif
Endif
Return

#------------------------------------------------------------------------------------#
#Validations before creation
#------------------------------------------------------------------------------------#
$INICRE
  Gosub VALIDATEPJM
Return

#------------------------------------------------------------------------------------#
#Validations before modification
#------------------------------------------------------------------------------------#
$VERIF_MOD
  Gosub VALIDATEPJM
  Gosub VALBUD

  #check if the web service had an error.
  If GWEBSERV
    If GYOK = 0
      OK = 0
    Endif
  Endif

Return

#------------------------------------------------------------------------------------#
#Open tables for use
#------------------------------------------------------------------------------------#
$OUVRE

If clalev([F:YGAC])  = 0 : Local File GACCOUNT[YGAC]     : Endif
If clalev([F:YPJM])  = 0 : Local File OPPORPJM[YPJM]     : Endif
If clalev([F:YBAN])  = 0 : Local File BANK[YBAN]         : Endif
If clalev([F:YBID])  = 0 : Local File BID[YBID]          : Endif
If clalev([F:YAPN])  = 0 : Local File YAPNINVOICE [YAPN] : Endif
If clalev([F:YPIH])  = 0 : Local File PINVOICE [YPIH]    : Endif
If clalev([F:YPIL])  = 0 : Local File BPSINVLIG [YPIL]   : Endif
If clalev([F:YPCC])  = 0 : Local File YPCCACC[YPCC]      : Endif
If clalev([F:YVAC])  = 0 : Local File TABVACBPR[YVAC]    : Endif
If clalev([F:YBPS])  = 0 : Local File BPSUPPLIER[YBPS]   : Endif
If clalev([F:YCPY])  = 0 : Local File COMPANY  [YCPY]    : Endif
If clalev([F:YGACM]) = 0 : Local File GACM     [YGACM]   : Endif
If clalev([F:YGLED]) = 0 : Local File GLED     [YGLED]   : Endif
If clalev([F:YPJB])  = 0 : Local File PJMBUDLIG [YPJB]   : Endif
If clalev([F:YPIM])  = 0 : Local File PIMPL [YPIM]       : Endif
If clalev([F:YBPR])  = 0 : Local File BPARTNER [YBPR]    : Endif
If clalev([F:YVAT])  = 0 : Local File TABVAT [YVAT]      : Endif
If clalev([F:YCPY])  = 0 : Local File COMPANY [YCPY]      : Endif


Return

#------------------------------------------------------------------------------------#
#
#------------------------------------------------------------------------------------#
Subprog AM_DIE(VALEUR)
Variable Char    VALEUR()
End


#------------------------------------------------------------------------------------#
#
#------------------------------------------------------------------------------------#
Subprog AM_ACC1(VALEUR)
Variable Char    VALEUR()

End


#------------------------------------------------------------------------------------#
#Validate PJM linked accounts
#------------------------------------------------------------------------------------#
$VALIDATEPJM

Local Char YMSG(250)

  For I = 0 To [M:BIS3]NBLIG-1

  Filter [F:YGAC] Where ACC = [M:BIS3]ACC1(I)
  For [F:YGAC]

  If [F:YGAC]YPJM = 2 and [M:BIS3]PJTLIN(I) = ""
    YMSG += num$(I + 1) + ", "
  Endif

  Next
  Filter [F:YGAC]

  Next

  If len(YMSG) > 0
    GMESSAGE = mess(2,6201,1) + left$(YMSG,len(YMSG)-2) # "Please enter a project code on the following lines: " + ZMSG
    GERR = 1
    GOK = 0
  Endif

Return

#------------------------------------------------------------------------------------#
#After line, do PJM validations
#------------------------------------------------------------------------------------#
Subprog AP_PJTLIN(VALEUR)
Variable Char    VALEUR()

Local Char YPRJNUM,YBUDCOD
Local Integer YVAL
Local Char YAMT1(30)

If VALEUR = ""
  YVAL = func YDFCGENERAL.VAL_PJM([M:BIS3]ACC1(nolign-1))
#  If YVAL = 2
#    Call ERRTIT( mess(1,6201,1),"Mandatory field") From GESECRAN
#    mkstat = 2
#  Endif
Else
  If instr(1,VALEUR,":") > 0
    YAMT1 = seg$(VALEUR,instr(1,VALEUR,":")+1,len(VALEUR))
    [M:BIS3]YBUDAMT(nolign-1) =  val( YAMT1)
    Affzo [M:BIS3]YBUDAMT(nolign-1)
    VALEUR = left$(VALEUR,instr(1,VALEUR,":")-1)
  Else
    If (instr(1,VALEUR,"!")) > 0
      YPRJNUM =  seg$(VALEUR,1,instr(1,VALEUR,"!")-1)
      YBUDCOD =  seg$(VALEUR,instr(1,VALEUR,"!")+2,len(VALEUR))

      #get the latest budget amount.
      Filter [F:YPJB]
      Filter [F:YPJB] Where OPPNUM = YPRJNUM and PBUCOD = YBUDCOD and PLBFCY = [M:BIS0]FCY
      Read [F:YPJB] First
      [M:BIS3]YBUDAMT(nolign-1) = [F:YPJB]PLBAMT

      Affzo [M:BIS3]YBUDAMT(nolign-1)
    Endif
  Endif

Local Decimal YAPPERC
Local Decimal YAPAMT

# get the AP Tollorance and Amount
Read[F:YCPY]CPY0 = [M:BIS0]CPY
If fstat = 0
  YAPPERC = [F:YCPY]YAPTPCT
  YAPAMT  = [F:YCPY]YAPTAMT
Endif

  #get the amount remaining.
  Local Char ZSQL(255)(3)
  Local Decimal YSPENT
  ZSQL(0) = "SELECT SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
  ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + VALEUR + "'"# AND H.STA_0 = 2"

For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]

  [M:BIS3]YALLOCAMT(nolign-1) = [F:YLNK]YAMT
  Affzo [M:BIS3]YALLOCAMT(nolign-1)

  If ([M:BIS3]YBUDAMT(nolign-1) * (1+YAPPERC)) > ([M:BIS3]YBUDAMT(nolign-1) +YAPAMT)
    [M:BIS3]YBUDAMT(nolign-1) = ([M:BIS3]YBUDAMT(nolign-1) +YAPAMT)
  Else
    [M:BIS3]YBUDAMT(nolign-1) = ([M:BIS3]YBUDAMT(nolign-1) * (1+YAPPERC))
  Endif
  Affzo [M:BIS3]YBUDAMT(nolign-1)


  [M:BIS3]YRMNAMT(nolign-1) = [M:BIS3]YBUDAMT(nolign-1) - [M:BIS3]YALLOCAMT(nolign-1)
  Affzo [M:BIS3]YRMNAMT(nolign-1)

#  If [M:BIS3]AMTNOTLIN(nolign-1) > [M:BIS3]YRMNAMT(nolign-1)
#    GMESSAGE = "The invoice amount before tax is more than the remaining budgeted amount."
#    GERR = 1
#    zonsui = "[M:BIS3]AMTATILIN(" + num$(nolign - 1) + ")"
#    [M:BIS1]STA = 4
#    Affzo [M:BIS1]STA
#  Endif
Next

Endif

Local Char YQRY(255)(5)

Read [F:YCPY]CPY0 = [M:BIS0]CPY
If fstat = 0
  Read [F:YGACM]GCM0 = [F:YCPY]ACM
    If fstat = 0
      Case [F:YGACM]GENLEDTYP
      When 1  : Read [F:YGLED]LED0 = [F:YGACM]LED(0)
      When 2  : Read [F:YGLED]LED0 = [F:YGACM]LED(1)
      When 3  : Read [F:YGLED]LED0 = [F:YGACM]LED(2)
      When 4  : Read [F:YGLED]LED0 = [F:YGACM]LED(3)
      When 5  : Read [F:YGLED]LED0 = [F:YGACM]LED(4)
      When 6  : Read [F:YGLED]LED0 = [F:YGACM]LED(5)
      When 7  : Read [F:YGLED]LED0 = [F:YGACM]LED(6)
      When 8  : Read [F:YGLED]LED0 = [F:YGACM]LED(7)
      When 9  : Read [F:YGLED]LED0 = [F:YGACM]LED(8)
      When 10 : Read [F:YGLED]LED0 = [F:YGACM]LED(9)
      Endcase

      Read [F:YGAC]GAC0 = [F:YGLED]COA ; [M:BIS3]ACC1(nolign-1)
      If [F:YGAC]YPJM = 2
          Read [F:YPIM]PIM0 = VALEUR
          If fstat = 0
            YQRY(0) = "select D.CCE_0 as Cost_Centre,P.CCE_2 as JobDimension "
            YQRY(1) = "from PJMBUDLIG B "
            YQRY(2) = "inner join PJMCOSTCTR D on B.PCCCOD_0 = D.PCCCOD_0 "
            YQRY(3) = "inner join OPPORPJM P on P.OPPNUM_0 = B.OPPNUM_0 "
            YQRY(4) = "WHERE B.OPPNUM_0 = '"+[F:YPIM]OPPNUM+"' AND B.PBUCOD_0 = '"+[F:YPIM]PBUCOD+"'"
            For (Char COST_CENTRE, Char JOB) From "5" Sql YQRY As [YSQL]
#            Infbox num$([F:YSQL]COST_CENTRE) + " " + [F:YSQL]JOB
             [M:BIS3]CCE3(nolign-1) = [F:YSQL]JOB
             [M:BIS3]CCE4(nolign-1) = [F:YSQL]COST_CENTRE
            Next
          Endif
      Endif
    Endif
Affzo [M:BIS3]
Endif

End

#------------------------------------------------------------------------------------#
#After line, do PJM validations
#------------------------------------------------------------------------------------#
Subprog APRES_NBLIG

Local Integer YVAL

If [M:BIS3]PJTLIN(nolign-1) <> ""

Local Char YPRJNUM,YBUDCOD
Local Decimal YBUDAMT

  # see if any of the lines entered is over budget.


  If (instr(1,[M:BIS3]PJTLIN(nolign-1),"!")) <= 0
    GMESSAGE = "Project and budget codes could not be determined. Please ensure that a project and budget code was entered."
    GERR = 1
        [M:BIS1]YOVRBUD = 2
        Affzo [M:BIS1]YOVRBUD

        If GWEBSERV
           GYOK = 0
        Endif
    End
  Endif

  #get the project and budget code

  YPRJNUM =  seg$([M:BIS3]PJTLIN(nolign-1),1,instr(1,[M:BIS3]PJTLIN(nolign-1),"!")-1)
  YBUDCOD =  seg$([M:BIS3]PJTLIN(nolign-1),instr(1,[M:BIS3]PJTLIN(nolign-1),"!")+2,len([M:BIS3]PJTLIN(nolign-1)))

  #get the latest budget amount.
  Filter [F:YPJB]
  Filter [F:YPJB] Where OPPNUM = YPRJNUM and PBUCOD = YBUDCOD and PLBFCY = [M:BIS0]FCY
  Read [F:YPJB] First
  [M:BIS3]YBUDAMT(nolign-1) = [F:YPJB]PLBAMT
  Affzo [M:BIS3]YBUDAMT(nolign-1)

  Local Decimal YAPPERC
  Local Decimal YAPAMT

  # get the AP Tollorance and Amount
  Read[F:YCPY]CPY0 = [M:BIS0]CPY
  If fstat = 0
    YAPPERC = [F:YCPY]YAPTPCT
    YAPAMT  = [F:YCPY]YAPTAMT
  Endif
#
#    #get the amount remaining.
    Local Char ZSQL(255)(3)
    Local Decimal YSPENT
    ZSQL(0) = "SELECT SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
    ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + [M:BIS3]PJTLIN(nolign-1) + "'"# AND H.STA_0 = 2"
#
    For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]


      [M:BIS3]YALLOCAMT(nolign-1) = [F:YLNK]YAMT
      Affzo [M:BIS3]YALLOCAMT(nolign-1)

      If ([M:BIS3]YBUDAMT(nolign-1) * (1+YAPPERC)) > ([M:BIS3]YBUDAMT(nolign-1) +YAPAMT)
        [M:BIS3]YBUDAMT(nolign-1) = ([M:BIS3]YBUDAMT(nolign-1) +YAPAMT)
      Else
        [M:BIS3]YBUDAMT(nolign-1) = ([M:BIS3]YBUDAMT(nolign-1) * (1+YAPPERC))
      Endif
      Affzo [M:BIS3]YBUDAMT(nolign-1)


      [M:BIS3]YRMNAMT(nolign-1) = [M:BIS3]YBUDAMT(nolign-1) - [M:BIS3]YALLOCAMT(nolign-1)
      Affzo [M:BIS3]YRMNAMT(nolign-1)

      If [M:BIS3]AMTNOTLIN(nolign-1) > [M:BIS3]YRMNAMT(nolign-1)
        GMESSAGE = "The invoice amount before tax is more than the remaining budgeted amount."
        GERR = 1
        [M:BIS1]YOVRBUD = 2
        Affzo [M:BIS1]YOVRBUD

#        If GWEBSERV
#          GYOK = 0
#        Endif
      Endif
    Next
Endif

End


#------------------------------------------------------------------------------------#
#Validations before creation
#------------------------------------------------------------------------------------#
$VERIF_CRE

  Gosub VALIDATESUPREF
  Gosub VALIDATENAVREF

  Gosub VALBUD
  Gosub VALIDATEPJM

  #check if the web service had an error.
  If GWEBSERV
    If GYOK = 0
      OK = 0
    Endif
  Endif

Return


#------------------------------------------------------------------------------------#
#Validate X3 invoice reference
#------------------------------------------------------------------------------------#
$VALIDATESUPREF
Filter [F:YPIH]
Filter [F:YPIH] Where [F:YPIH]BPRVCR = [M:BIS1]BPRVCR and [F:YPIH]BPR = [M:BIS0]BPR

If rowcount([F:YPIH]) > 0
  Read [F:YPIH] First
  GERR = 1 : GMESSAGE = "Reference entered on invoice " + [F:YPIH]NUM : OK = 0 : GOK = 0

  #if the web service is called and validation fails, flag the error variable
  If GWEBSERV
    GYOK = 0
  Endif
Endif

Return


#------------------------------------------------------------------------------------#
#Validate Navision invoice reference
#------------------------------------------------------------------------------------#
$VALIDATENAVREF
Filter [F:YAPN]
Filter [F:YAPN] Where [F:YAPN]YNUM = val([M:BIS1]BPRVCR) and [F:YAPN]YBPS = [M:BIS0]BPR

If rowcount([F:YAPN]) > 0
  Read [F:YAPN] First

  #if the web service is called and validation fails, flag the error variable
  If !GWEBSERV
    GERR = 1 : GMESSAGE = "Reference entered is on Navision invoice " + num$([F:YAPN]YNUM) : OK = 0 : GOK = 0 : Return
  Endif


Endif
Return

######################################################################################
## Section automatically added (screen BIS1) 06/07/2018 02:06:28 (MICHB)
######################################################################################
#------------------------------------------------------------------------------------#
#SETS THE DEFAULT BANK VALUE TO THE DEFAULT BANK FROM PJM
#------------------------------------------------------------------------------------#
Subprog AP_PJTH(VALEUR)
Variable Char    VALEUR()

Read [F:YPIM]PIM0 = VALEUR
If fstat = 0
  Read [F:YPJM]OPPPJM0 = [F:YPIM]OPPNUM
  If fstat = 0
    #DFCX1-47 Only override Bank if there is a value in Project
    If [F:YPJM]YDEFBAN <> ""
      [M:BIS1]YPAYBANK = [F:YPJM]YDEFBAN
      Affzo [M:BIS1]YPAYBANK
    Endif
  Endif
Endif
End


######################################################################################

######################################################################################
## Section automatically added (screen BIS0) 06/07/2018 02:50:54 (MICHB)
######################################################################################
Subprog AP_BPR(VALEUR)
Variable Char    VALEUR()
#MANTIS HUB ISSUE 0000069 - SUPPLIER NAME NOT DEFAULTING AFTER CHOOSING A SUPPLIER

Read [F:YBPS]BPS0 = VALEUR
If fstat = 0

  [M:BIS0]BPRNAM = [F:YBPS]BPSNAM
  Affzo [M:BIS0]BPRNAM
Endif

zonsui = "[M:BIS1]BPRDAT"

Read [F:YBPR]BPR0 = VALEUR
If fstat = 0
  [M:BIS0]YCRN = [F:YBPR]CRN
  Affzo [M:BIS0]YCRN
Endif

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS0) 06/07/2018 03:07:08 (MICHB)
######################################################################################
#------------------------------------------------------------------------------------#
#SETS THE DEFAULT BANK VALUE TO THE DEFAULT BANK FROM COMPANY
#------------------------------------------------------------------------------------#
Subprog AP_FCY(VALEUR)
Variable Char    VALEUR()
Local Char QRY(255)

QRY = "SELECT COUNT(BAN_0)  FROM BANK WHERE CPY_0 = '"+[M:BIS0]CPY+"'"
For (Integer BANCOUNT) From "5" Sql QRY As [YSQL]
#Infbox num$([F:YLNK]BANCOUNT)

Read [F:YBAN]BAN3 = [M:BIS0]CPY
#Filter [F:YBAN] Where [F:YBAN]CPY = [M:BIS0]CPY
If fstat = 0
If [F:YSQL]BANCOUNT < 2
  [M:BIS1]YPAYBANK = [F:YBAN]BAN
  Affzo [M:BIS1]YPAYBANK
 Else
  [M:BIS1]YPAYBANK = ""
  Affzo [M:BIS1]YPAYBANK
Endif
Endif
Next

zonsui = "[M:BIS0]BPR"

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS0) 10/07/2018 05:13:12 (MICHB)
######################################################################################
Subprog AP_BPAINV(VALEUR)
Variable Char    VALEUR()

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 11/07/2018 03:49:52 (JANM)
######################################################################################
Subprog AM_CCE1(VALEUR)
Variable Char    VALEUR()
End

Subprog AM_CCE2(VALEUR)
Variable Char    VALEUR()
End

Subprog AM_CCE3(VALEUR)
Variable Char    VALEUR()
End

Subprog AM_CCE4(VALEUR)
Variable Char    VALEUR()
End

Subprog AM_CCE5(VALEUR)
Variable Char    VALEUR()
End


######################################################################################

######################################################################################
## Section automatically added (screen BIS0) 12/07/2018 04:18:37 (MICHB)
######################################################################################
Subprog AS_FCY(VALEUR)
Variable Char    VALEUR()
zonsui = "[M:BIS0]BPR"
End

Subprog AS_BPAINV(VALEUR)
Variable Char    VALEUR()

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS0) 12/07/2018 04:46:52 (MICHB)
######################################################################################
Subprog AV_BPAINV(VALEUR)
Variable Char    VALEUR()

End


######################################################################################




######################################################################################
## Section automatically added (screen BIS3) 24/07/2018 02:21:11 (MICHB)
######################################################################################
#------------------------------------------------------------------------------------#
#SETS INVOICE LINE DIMENSION FIELDS BASED ON PROJECT
#------------------------------------------------------------------------------------#
Subprog AS_PJTLIN(VALEUR)
Variable Char    VALEUR()
End

Local Integer YVAL
Local Char YAMT1(30)

#If VALEUR = ""
#  YVAL = func YDFCGENERAL.VAL_PJM([M:BIS3]ACC1(nolign-1))
#  If YVAL = 2
#    Call ERRTIT( mess(1,6201,1),"Mandatory field") From GESECRAN
#    mkstat = 2
#  Endif
#Else
#  If instr(1,VALEUR,":") > 0
#    YAMT1 = seg$(VALEUR,instr(1,VALEUR,":")+1,len(VALEUR))
#    [M:BIS3]YBUDAMT(nolign-1) =  val( YAMT1)
#    Affzo [M:BIS3]YBUDAMT(nolign-1)
#    VALEUR = left$(VALEUR,instr(1,VALEUR,":")-1)
#  Endif
#
#Local Decimal YAPPERC
#Local Decimal YAPAMT
#
## get the AP Tollorance and Amount
#Read[F:YCPY]CPY0 = [M:BIS0]CPY
#If fstat = 0
#  YAPPERC = [F:YCPY]YAPTPCT
#  YAPAMT  = [F:YCPY]YAPTAMT
#Endif
#
#
#  #get the amount remaining.
#  Local Char ZSQL(255)(3)
#  Local Decimal YSPENT
#  ZSQL(0) = "select SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
#  ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + VALEUR + "' AND H.STA_0 = 2"
#
#For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]
#
#  [M:BIS3]YALLOCAMT(nolign-1) = [F:YLNK]YAMT
#  Affzo [M:BIS3]YALLOCAMT(nolign-1)
#
#  [M:BIS3]YRMNAMT(nolign-1) = [M:BIS3]YBUDAMT(nolign-1) - [M:BIS3]YALLOCAMT(nolign-1)
#  Affzo [M:BIS3]YRMNAMT(nolign-1)
#
#
#If ([M:BIS3]YRMNAMT(nolign-1) * (1+YAPPERC)) > ([M:BIS3]YRMNAMT(nolign-1) +YAPAMT)
#  [M:BIS3]YRMNAMT(nolign-1) = ([M:BIS3]YRMNAMT(nolign-1) +YAPAMT)
#Else
#  [M:BIS3]YRMNAMT(nolign-1) = ([M:BIS3]YRMNAMT(nolign-1) * (1+YAPPERC))
#Endif
##
##If [M:BIS3]AMTNOTLIN(nolign-1) > [M:BIS3]YRMNAMT(nolign-1) AAAAAA
#
#  If [M:BIS3]AMTNOTLIN(nolign-1) > [M:BIS3]YRMNAMT(nolign-1)
#    GMESSAGE = "The invoice amount before tax is more than the remaining budgeted amount."
#    GERR = 1
#    zonsui = "[M:BIS3]AMTATILIN(" + num$(nolign - 1) + ")"
#  Endif
#Next
#
#Endif

Local Char YQRY(255)(5)

Read [F:YCPY]CPY0 = [M:BIS0]CPY
If fstat = 0
  Read [F:YGACM]GCM0 = [F:YCPY]ACM
    If fstat = 0
      Case [F:YGACM]GENLEDTYP
      When 1  : Read [F:YGLED]LED0 = [F:YGACM]LED(0)
      When 2  : Read [F:YGLED]LED0 = [F:YGACM]LED(1)
      When 3  : Read [F:YGLED]LED0 = [F:YGACM]LED(2)
      When 4  : Read [F:YGLED]LED0 = [F:YGACM]LED(3)
      When 5  : Read [F:YGLED]LED0 = [F:YGACM]LED(4)
      When 6  : Read [F:YGLED]LED0 = [F:YGACM]LED(5)
      When 7  : Read [F:YGLED]LED0 = [F:YGACM]LED(6)
      When 8  : Read [F:YGLED]LED0 = [F:YGACM]LED(7)
      When 9  : Read [F:YGLED]LED0 = [F:YGACM]LED(8)
      When 10 : Read [F:YGLED]LED0 = [F:YGACM]LED(9)
      Endcase

      Read [F:YGAC]GAC0 = [F:YGLED]COA ; [M:BIS3]ACC1(nolign-1)
      If [F:YGAC]YPJM = 2
          Read [F:YPIM]PIM0 = VALEUR
          If fstat = 0
            YQRY(0) = "select D.CCE_0 as Cost_Centre,P.CCE_2 as JobDimension "
            YQRY(1) = "from PJMBUDLIG B "
            YQRY(2) = "inner join PJMCOSTCTR D on B.PCCCOD_0 = D.PCCCOD_0 "
            YQRY(3) = "inner join OPPORPJM P on P.OPPNUM_0 = B.OPPNUM_0 "
            YQRY(4) = "WHERE B.OPPNUM_0 = '"+[F:YPIM]OPPNUM+"' AND B.PBUCOD_0 = '"+[F:YPIM]PBUCOD+"'"
            For (Char COST_CENTRE, Char JOB) From "5" Sql YQRY As [YSQL]
#            Infbox num$([F:YSQL]COST_CENTRE) + " " + [F:YSQL]JOB
             [M:BIS3]CCE3(nolign-1) = [F:YSQL]JOB
             [M:BIS3]CCE4(nolign-1) = [F:YSQL]COST_CENTRE
            Next
          Endif
      Endif
    Endif
Affzo [M:BIS3]
Endif

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 25/07/2018 18:27:33 (MB)
######################################################################################
#------------------------------------------------------------------------------------#
#GST LINE ENTRY
#------------------------------------------------------------------------------------#
Subprog AS_VAT(VALEUR)
Variable Char    VALEUR()

#For I = 0 To [M:BIS3]NBLIG-1
#
Read [F:YCPY]CPY0 = [M:BIS0]CPY
If fstat = 0
  Read [F:YGACM]GCM0 = [F:YCPY]ACM
    If fstat = 0
      Case [F:YGACM]GENLEDTYP
      When 1  : Read [F:YGLED]LED0 = [F:YGACM]LED(0)
      When 2  : Read [F:YGLED]LED0 = [F:YGACM]LED(1)
      When 3  : Read [F:YGLED]LED0 = [F:YGACM]LED(2)
      When 4  : Read [F:YGLED]LED0 = [F:YGACM]LED(3)
      When 5  : Read [F:YGLED]LED0 = [F:YGACM]LED(4)
      When 6  : Read [F:YGLED]LED0 = [F:YGACM]LED(5)
      When 7  : Read [F:YGLED]LED0 = [F:YGACM]LED(6)
      When 8  : Read [F:YGLED]LED0 = [F:YGACM]LED(7)
      When 9  : Read [F:YGLED]LED0 = [F:YGACM]LED(8)
      When 10 : Read [F:YGLED]LED0 = [F:YGACM]LED(9)
      Endcase

      Read [F:YGAC]GAC0 = [F:YGLED]COA ; [M:BIS3]ACC1(nolign-1)
      If [F:YGAC]FLGVAT = 2
          Read [F:YBPS]BPS0 = [M:BIS0]BPR
          If fstat = 0
            Read [F:YVAC]TVB0 = [F:YBPS]VACBPR ; ""
            If [F:YVAC]VAT = ""
                VALEUR = [F:YGAC]VAT
            Else
              VALEUR = [F:YVAC]VAT
            Endif
          Endif
      Endif
    Endif
Affzo [M:BIS3]
Endif
#
#Next
#GPE = 1



End

######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 27/07/2018 03:44:18 (MB)
######################################################################################
Subprog AP_VAT(VALEUR)
Variable Char    VALEUR()

If clalev([M:BIHT])  = 0 : Local Mask BIST [BIHT]      : Endif

If [M:BIS3]AMTNOTLIN(nolign-1) <> 0

  Read [F:YVAT]TVT1 = VALEUR
  If [M:BIS1]PURPRITYP = 2
#    [M:BIS3]AMTVAT(nolign-1) = (([M:BIS3]AMTNOTLIN(nolign-1) / (1 +([F:YVAT]VATRAT / 100))) - [M:BIS3]AMTNOTLIN(nolign-1)) *-1
    [M:BIS3]AMTVAT(nolign-1) =  (([M:BIS3]AMTATILIN(nolign-1) / (1 +([F:YVAT]VATRAT / 100))) - [M:BIS3]AMTATILIN(nolign-1)) *-1
    Affzo [M:BIS3]AMTVAT(nolign-1)
  Else
#    [M:BIS3]AMTVAT(nolign-1) = [M:BIS3]AMTNOTLIN(nolign-1) * ([F:YVAT]VATRAT / 100)
#    Affzo [M:BIS3]AMTVAT(nolign-1)
  Endif
Endif

End


######################################################################################
Subprog AM_BPRVCR(VALEUR)
Variable Char    VALEUR()

If VALEUR <> ""
  # Check if the Supplier invoice number exists already
  Filter [F:YPIH]
  Filter [F:YPIH] Where [F:YPIH]BPRVCR = VALEUR and [F:YPIH]BPR = [M:BIS0]BPR

  If rowcount([F:YPIH]) > 0
    Read [F:YPIH] First
    #Disable the Create button if reference number is duplicated
    Disable GSTACRE
    Infbox("Reference entered on invoice " + [F:YPIH]NUM + "." + chr$(13) + chr$(10) + "Please click on the Document no. magnifier to open the document")
    Raz [M:BIS0]
    Raz [M:BIS1]
    Affzo [M]
    [M:BIS0]NUM = [F:YPIH]NUM
    Affzo [M:BIS0]NUM
    mkstat = 2


    #Nap "GESBIS/1/OBJBIS/M/PIN1807002-100011"
#    Affzo [M:BIS0]
#    Affzo [M:BIS1]
  Else
    #Enable the Create button if reference number is not duplicated
    Enable GSTACRE

    # Validate Navision invoice reference
    Filter [F:YAPN]
    Filter [F:YAPN] Where [F:YAPN]YINVNUM = VALEUR and [F:YAPN]YBPS = [M:BIS0]BPR

    If fstat = 0
      If rowcount([F:YAPN]) > 0
        Read [F:YAPN] First
        GERR = 1 : GMESSAGE = "Reference entered is on Navision invoice " + num$([F:YAPN]YINVNUM) : mkstat = 2 : End
      Endif
    Endif
  Endif
Endif
End

######################################################################################
## Section automatically added (screen BIS1) 30/07/2018 06:03:14 (MB)
######################################################################################
#------------------------------------------------------------------------------------#
#Supplier Bank Account After Change
#------------------------------------------------------------------------------------#
Subprog AM_BPRPAY(VALEUR)
Variable Char    VALEUR()

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS1) 31/07/2018 04:33:22 (MB)
######################################################################################
#------------------------------------------------------------------------------------#
#DEFAULT THE PAYTO AND SET FOCUS
#------------------------------------------------------------------------------------#
Subprog AM_AMTATI(VALEUR)
Variable Decimal VALEUR

[M:BIS1]BPRPAY = [M:BIS0]BPR
Affzo [M:BIS1]BPRPAY
#zonsui = "[M:BIS1]BPRPAY"

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS1) 31/07/2018 04:54:34 (MB)
######################################################################################
#------------------------------------------------------------------------------------#
#Supplier Bank Account
#------------------------------------------------------------------------------------#
Subprog AP_BPRPAY(VALEUR)
Variable Char    VALEUR()
End
#Local Char QRY(255)
#Local Char QRY1(255)
#Local Char QRY2(255)
#
#If [M:BIS1]BPAPAY = ""
#  QRY = "SELECT COUNT(BPAADD_0) FROM BID  WHERE BPANUM_0 = '"+VALEUR+"' "
#  For (Integer ADDCOUNT) From "5" Sql QRY As [YSQL]
#  If [F:YSQL]ADDCOUNT > 1
#    [M:BIS1]BPAPAY = ""
#    Affzo [M:BIS1]BPAPAY
#    Break
#  Else
#      QRY1 = "SELECT TOP 1 BPAADD_0 FROM BID  WHERE BPANUM_0 = '"+VALEUR+"' AND BIDNUMFLG_0 = 2"
#      For (Char ADDCOUNT1) From "5" Sql QRY1 As [YSQL1]
#        [M:BIS1]BPAPAY = [F:YSQL1]ADDCOUNT1
#
#        QRY2 = "SELECT TOP 1 PAB2_0, PAB3_0  FROM BID WHERE BPANUM_0 = '"+VALEUR+"' AND BPAADD_0 = '"+ ADDCOUNT1 +"'"
#        For (Char PAB2,Char PAB3) From "5" Sql QRY2 As [YSQL2]
#        [M:BIS1]YBPAYREF = [F:YSQL2]PAB3
#        [M:BIS1]YBILLCOD = [F:YSQL2]PAB2
#         Affzo [M:BIS1]
#        Next
#      Next
#  Endif
#  Next
#Endif
#End


######################################################################################

######################################################################################
## Section automatically added (screen BIS1) 31/07/2018 05:00:18 (MB)
######################################################################################
#------------------------------------------------------------------------------------#
#Supplier Bank Account
#------------------------------------------------------------------------------------#
Subprog AM_BPAPAY(VALEUR)
Variable Char    VALEUR()

  #Clear existing values
  [M:BIS1]YBPAYREF = ""
  [M:BIS1]YBILLCOD = ""

  #Check if we have a default Bank Address Details then select it
  Local Char QRY(255)
  QRY = "SELECT TOP 1 PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + [M:BIS1]BPRPAY + "' AND BPAADD_0 = '" + VALEUR + "' AND BIDNUMFLG_0 = 2"
  For (Char PAB2,Char PAB3) From "5" Sql QRY As [YSQL]
    [M:BIS1]YBPAYREF = [F:YSQL]PAB3
    [M:BIS1]YBILLCOD = [F:YSQL]PAB2
  Next

  Affzo [M:BIS1]YBPAYREF,YBILLCOD

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 31/07/2018 18:19:22 (JHM)
######################################################################################
Subprog AM_AMTATILIN(VALEUR)
Variable Decimal VALEUR
#
#If [M:BIS3]PJTLIN(nolign-1) <> ""
#
#Local Char YPRJNUM,YBUDCOD
#Local Decimal YBUDAMT
#
#  # see if any of the lines entered is over budget.
#
##  For I = 0 To [M:BIS3]NBLIG-1
#
#
#  If (instr(1,[M:BIS3]PJTLIN(nolign-1),"!")) <= 0
#    GMESSAGE = "Project and budget codes could not be determined. Please ensure that a project and budget code was entered."
#    GERR = 1
#    [M:BIS1]STA = 4
#    Affzo [M:BIS1]STA
#    End
#  Endif
#
#  #get the project and budget code
#
#  YPRJNUM =  seg$([M:BIS3]PJTLIN(nolign-1),1,instr(1,[M:BIS3]PJTLIN(nolign-1),"!")-1)
#  YBUDCOD =  seg$([M:BIS3]PJTLIN(nolign-1),instr(1,[M:BIS3]PJTLIN(nolign-1),"!")+2,len([M:BIS3]PJTLIN(nolign-1)))
#
#  #get the latest budget amount.
#  Filter [F:YPJB]
#  Filter [F:YPJB] Where OPPNUM = YPRJNUM and PBUCOD = YBUDCOD and PLBFCY = [M:BIS0]FCY
#  Read [F:YPJB] First
#  [M:BIS3]YBUDAMT(nolign-1) = [F:YPJB]PLBAMT
#  Affzo [M:BIS3]YBUDAMT(nolign-1)
#
#  Local Decimal YAPPERC
#  Local Decimal YAPAMT
#
#  # get the AP Tollorance and Amount
#  Read[F:YCPY]CPY0 = [M:BIS0]CPY
#  If fstat = 0
#    YAPPERC = [F:YCPY]YAPTPCT
#    YAPAMT  = [F:YCPY]YAPTAMT
#  Endif
##
##    #get the amount remaining.
#    Local Char ZSQL(255)(3)
#    Local Decimal YSPENT
#    ZSQL(0) = "SELECT SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
#    ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + YPRJNUM + "'"# AND H.STA_0 = 2"
##
#    For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]
#
#      [M:BIS3]YALLOCAMT(nolign-1) = [F:YLNK]YAMT
#      Affzo [M:BIS3]YALLOCAMT(nolign-1)
#
#      [M:BIS3]YRMNAMT(nolign-1) = [M:BIS3]YBUDAMT(nolign-1) - [M:BIS3]YALLOCAMT(nolign-1)
#      Affzo [M:BIS3]YRMNAMT(nolign-1)
#
#    If ([M:BIS3]YRMNAMT(nolign-1) * (1+YAPPERC)) > ([M:BIS3]YRMNAMT(nolign-1) +YAPAMT)
#      [M:BIS3]YRMNAMT(nolign-1) = ([M:BIS3]YRMNAMT(nolign-1) +YAPAMT)
#    Else
#      [M:BIS3]YRMNAMT(nolign-1) = ([M:BIS3]YRMNAMT(nolign-1) * (1+YAPPERC))
#    Endif
#
#      If VALEUR > [M:BIS3]YRMNAMT(nolign-1)
#        GMESSAGE = "The invoice amount is more than the remaining budgeted amount."
#        GERR = 1
#        [M:BIS1]STA = 4
#        Affzo [M:BIS1]STA
#      Endif
#    Next
#
##  Next
#
##  [M:BIS3]YRMNAMT(nolign-1) = [M:BIS3]YBUDAMT(nolign-1) - VALEUR
##  Affzo [M:BIS3]YRMNAMT(nolign-1)
##
##  If VALEUR > [M:BIS3]YRMNAMT(nolign-1)
##    GMESSAGE = "The invoice amount is more than the remaining budgeted amount."
##    GERR = 1
##    #zonsui = "[M:BIC3]AMTATILIN(" + num$(nolign-1) + ")"
##    #GOK = 0
##  Endif
#Endif




End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 01/08/2018 02:38:31 (MB)
######################################################################################
Subprog AP_AMTATILIN(VALEUR)
Variable Decimal VALEUR

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 02/08/2018 04:23:33 (MB)
######################################################################################
Subprog AV_ACC1(VALEUR)
Variable Char    VALEUR()

End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 02/08/2018 04:27:02 (MB)
######################################################################################
Subprog AS_ACC1(VALEUR)
Variable Char    VALEUR()

Read [F:YBPS]BPS0 = [M:BIS1]BPRPAY
If fstat = 0
  If VALEUR = ""
    If [F:YBPS]YDEFGL <> ""
      VALEUR = [F:YBPS]YDEFGL
      Affzo [M:BIS3]
    Endif
  Endif
Endif


End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 08/14/2018 05:24:45 (ADMIN)
######################################################################################
Subprog AP_CCE2(VALEUR)
Variable Char    VALEUR()
End

Subprog AP_CCE3(VALEUR)
Variable Char    VALEUR()
End


######################################################################################

$STYLE
#  #DFCX1-153 - DW -  the user must be unable to selected Project Header - Start
#  If func AFNC.ACTIV("YPJM") = 1
#    If dim([M:BIC1]PJTH)>0 : Chgfmt [M:BIC1]PJTH With "-K:40X" : Raz [M:BIC1]PJTH : Endif
#  Endif
#  #DFCX1-153 - DW -  the user must be unable to selected Project Header - End
#  If [M:BIS1]YOVRBUD = 2
#    GMESSAGE = "The project's budget is exceeded. Posting of the invoice is disabled. Please correct the budget or invoice."
#    GERR = 1
#  Endif
Return

######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 22/08/2018 16:57:45 (MB)
######################################################################################
Subprog AS_AMTATILIN(VALEUR)
Variable Decimal VALEUR

If nolign = 1
VALEUR = [M:BIS1]AMTATI
Endif
End



######################################################################################


$SETBOUT
  [M:BIS3]YTAX1 = 0
  For I = 0 To [M:BIS3]NBLIG-1
    [M:BIS3]YTAX1 += [M:BIS3]AMTVAT(I)
  Next
  Affzo [M:BIS3]YTAX1

  #disable post button if the budget is exceeded.
  If [M:BIS1]YOVRBUD = 2
    Call VIREBOUT(CHAINE,"V") From GOBJET
  Endif

Return

######################################################################################
## Section automatically added (screen BIS1) 26/09/2018 15:45:36 (JHM)
######################################################################################
Subprog AM_STA(VALEUR)
Variable Integer VALEUR


End


######################################################################################

######################################################################################
## Section automatically added (screen BIS3) 28/09/2018 18:03:36 (JHM)
######################################################################################
Subprog AM_AMTNOTLIN(VALEUR)
Variable Decimal VALEUR


End


######################################################################################
$VALBUD

Local Char YPRJNUM,YBUDCOD
Local Decimal YBUDAMT

  # see if any of the lines entered is over budget.

#clear the status
[M:BIS1]YOVRBUD = 1
Affzo [M:BIS1]YOVRBUD

  For I = 0 To [M:BIS3]NBLIG-1

  Filter [F:YGAC] Where ACC = [M:BIS3]ACC1(I)
  For [F:YGAC]
  If [F:YGAC]YPJM = 2

    If (instr(1,[M:BIS3]PJTLIN(I),"!")) <= 0
      Errbox "Project and budget codes could not be determined. Please ensure that a project and budget code was entered."

      [M:BIS1]YOVRBUD = 2
      Affzo [M:BIS1]YOVRBUD

      If GWEBSERV
        GYOK = 0
      Endif
      Break
    Endif

    #get the project and budget code

    YPRJNUM =  seg$([M:BIS3]PJTLIN(I),1,instr(1,[M:BIS3]PJTLIN(I),"!")-1)
    YBUDCOD =  seg$([M:BIS3]PJTLIN(I),instr(1,[M:BIS3]PJTLIN(I),"!")+2,len([M:BIS3]PJTLIN(I)))

    #get the latest budget amount.
    Filter [F:YPJB]
    Filter [F:YPJB] Where OPPNUM = YPRJNUM and PBUCOD = YBUDCOD and PLBFCY = [M:BIS0]FCY
    Read [F:YPJB] First
    [M:BIS3]YBUDAMT(I) = [F:YPJB]PLBAMT

    Affzo [M:BIS3]YBUDAMT(I)

    Local Decimal YAPPERC
    Local Decimal YAPAMT

    # get the AP Tollorance and Amount
    Read[F:YCPY]CPY0 = [M:BIS0]CPY
    If fstat = 0
      YAPPERC = [F:YCPY]YAPTPCT
      YAPAMT  = [F:YCPY]YAPTAMT
    Endif
  #
  #    #get the amount remaining.
      Local Char ZSQL(255)(3)
      Local Decimal YSPENT
      Local Decimal YTOLAMT
      ZSQL(0) = "SELECT SUM(L.AMTNOTLIN_0 * H.SNS_0) as [amount spent] FROM BPSINVLIG L "
      ZSQL(1) = "LEFT OUTER JOIN PINVOICE H on H.NUM_0 = L.NUM_0 where PJTLIN_0 = '" + [M:BIS3]PJTLIN(I) + "'"# AND H.STA_0 = 2"
  #
      For (Decimal YAMT) From "5" Sql ZSQL As [YLNK]

        [M:BIS3]YALLOCAMT(I) = [F:YLNK]YAMT
        Affzo [M:BIS3]YALLOCAMT(I)

        If ([M:BIS3]YBUDAMT(I) * (1+YAPPERC)) > ([M:BIS3]YBUDAMT(I) +YAPAMT)
          [M:BIS3]YBUDAMT(I) = ([M:BIS3]YBUDAMT(I) +YAPAMT)
        Else
          [M:BIS3]YBUDAMT(I) = ([M:BIS3]YBUDAMT(I) * (1+YAPPERC))
        Endif
        Affzo [M:BIS3]YBUDAMT(I)


        [M:BIS3]YRMNAMT(I) = [M:BIS3]YBUDAMT(I) - [M:BIS3]YALLOCAMT(I)
        Affzo [M:BIS3]YRMNAMT(I)



        If [M:BIS3]AMTNOTLIN(I) > [M:BIS3]YRMNAMT(I)
          If !GWEBSERV
            Errbox "The invoice amount before tax is more than the remaining budgeted amount on line number: " + num$(I + 1)
            #GERR = 1
          Endif
          [M:BIS1]YOVRBUD = 2
          Affzo [M:BIS1]YOVRBUD

  #        If GWEBSERV
  #          GYOK = 0
  #        Endif

        Endif


     Next
    Endif
    Next

  Next
Filter [F:YGAC]
  #disable the post button
#  If [M:BIS1]YOVRBUD = 2
#    Call VIREBOUT(CHAINE,"V") From GOBJET
#  Endif

Return

######################################################################################
## Section automatically added (screen BIS3) 25/10/2018 06:18:19 (MB)
######################################################################################
Subprog AS_AMTNOTLIN(VALEUR)
Variable Decimal VALEUR

If [M:BIS1]PURPRITYP = 1
  If nolign = 1
    If [M:BIS1]AMTNOT > 0
    VALEUR = [M:BIS1]AMTNOT
    Else
    VALEUR = [M:BIS1]AMTATI
    Endif
  Endif
Else
  If nolign = 1
  VALEUR = [M:BIS1]AMTATI
  Endif
Endif

End


######################################################################################

#------------------------------------------------------------------------------------#
#Perform FCYLIN validations After Change
#------------------------------------------------------------------------------------#
Subprog AM_FCYLIN(VALEUR)
Variable Char    VALEUR()

  #DFCX1-50 Default the Project, Business Group, Job, and Cost Center based on selected header Project code
  If [M:BIS1]PJTH <> ""

    If !clalev ([F:YOPJM])   : Local File OPPORPJM   [F:YOPJM]  : Endif
    If !clalev ([F:YOPJL])   : Local File PIMPL      [F:YOPJL]  : Endif

    #Read Project Number from Project Link
    Read [F:YOPJL]PIM0 = [M:BIS1]PJTH

    If fstat = 0

      #Read Project
      Read [F:YOPJM]OPPPJM0 = [F:YOPJL]OPPNUM

      If fstat = 0

        #Set field values
        [M:BIS3]PJTLIN(nolign-1) = [M:BIS1]PJTH #Project
        [M:BIS3]CCE1(nolign-1) = [F:YOPJM]CCE(0) #Business Group
        [M:BIS3]CCE3(nolign-1) = [F:YOPJM]CCE(2) #Job
        [M:BIS3]CCE4(nolign-1) = [F:YOPJM]CCE(3) #Cost Centre

        #Refresh field values
        Affzo [M:BIS3]PJTLIN(nolign-1),CCE1(nolign-1),CCE3(nolign-1),CCE4(nolign-1)

      Endif

    Endif

    If clalev([F:YOPJM])     : Close Local File [F:YOPJM]       : Endif
    If clalev([F:YOPJL])     : Close Local File [F:YOPJL]       : Endif

  Endif
End


######################################################################################

######################################################################################
# Control - BPRPAY
######################################################################################
Subprog C_BPRPAY(VALEUR)
Variable Char    VALEUR()
Local Char QRY(255)
#DFCX1-49 Supplier Bank Account - Start

#Get count of Default Address Bank Details
QRY = "SELECT COUNT(BPAADD_0) FROM BID WHERE BPANUM_0 = '" + VALEUR + "' AND BIDNUMFLG_0 = 2"

For (Integer CNTADD) From "5" Sql QRY As [YSQL1]

  If [YSQL1]CNTADD = 1
    #One default - so we return this
    QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "' AND BIDNUMFLG_0 = 2"

    For (Char BKADD, Char PAB2, Char PAB3) From "5" Sql QRY As [YSQL2]
      [M:BIS1]BPAPAY    = [F:YSQL2]BKADD
      [M:BIS1]YBPAYREF  = [F:YSQL2]PAB3
      [M:BIS1]YBILLCOD  = [F:YSQL2]PAB2
      Break
    Next

  Elsif [YSQL1]CNTADD = 0
    #No default record - check for more than one non default record
    QRY = "SELECT COUNT(BPAADD_0) FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"

    For (Integer CNTADD) From "5" Sql QRY As [YSQL3]
      If [YSQL3]CNTADD = 1
        #Only one record - so we return this
        QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"

        For (Char BKADD, Char PAB2, Char PAB3) From "5" Sql QRY As [YSQL4]
          [M:BIS1]BPAPAY    = [F:YSQL4]BKADD
          [M:BIS1]YBPAYREF  = [F:YSQL4]PAB3
          [M:BIS1]YBILLCOD  = [F:YSQL4]PAB2
          Break
        Next
      Else
        #More than one record or no records - return nothing so user must pick
        [M:BIS1]BPAPAY = ""
        [M:BIS1]YBPAYREF = ""
        [M:BIS1]YBILLCOD = ""
      Endif
    Next

  Elsif [YSQL1]CNTADD > 1
    #More than one default record - return nothing so user must pick
    [M:BIS1]BPAPAY = ""
    [M:BIS1]YBPAYREF = ""
    [M:BIS1]YBILLCOD = ""
  Endif

Next

##Check if we have more than one Default Address for this Supplier
#QRY = "SELECT COUNT(BPAADD_0) FROM BPADDRESS WHERE BPANUM_0 = '" + VALEUR + "' AND BPAADDFLG_0 = 2"
#
#For (Integer CNTADD) From "5" Sql QRY As [YSQL]
#
#  If [YSQL]CNTADD = 1
#
#    #Get count of Address Bank Details
#    QRY = "SELECT COUNT(BPAADD_0) FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"
#
#    For (Integer CNTADD) From "5" Sql QRY As [YSQL1]
#
#      #Get Address Bank details if we only have one record, or get the Default if more than one
#      If [YSQL1]CNTADD = 1
#        QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"
#      Elsif [YSQL1]CNTADD > 1
#        QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "' AND BIDNUMFLG_0 = 2"
#      Endif
#
#      For (Char BKADD, Char PAB2, Char PAB3) From "5" Sql QRY As [YSQL2]
#        [M:BIS1]BPAPAY    = [F:YSQL2]BKADD
#        [M:BIS1]YBPAYREF  = [F:YSQL2]PAB3
#        [M:BIS1]YBILLCOD  = [F:YSQL2]PAB2
#        Break
#      Next
#
#    Next
#
#  Elsif [YSQL]CNTADD > 1
#
#    #Get count of Default Address Bank Details
#    QRY = "SELECT COUNT(BPAADD_0) FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"
#
#    For (Integer CNTADD) From "5" Sql QRY As [YSQL1]
#
#      #Get Address Bank details if we only have one record, or get the Default if more than one
#      If [YSQL1]CNTADD = 1
#        QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "'"
#      Else
#        QRY = "SELECT BPAADD_0, PAB2_0, PAB3_0 FROM BID WHERE BPANUM_0 = '" + VALEUR + "' AND BIDNUMFLG_0 = 2"
#      Endif
#
#      For (Char BKADD, Char PAB2, Char PAB3) From "5" Sql QRY As [YSQL2]
#        [M:BIS1]BPAPAY    = [F:YSQL2]BKADD
#        [M:BIS1]YBPAYREF  = [F:YSQL2]PAB3
#        [M:BIS1]YBILLCOD  = [F:YSQL2]PAB2
#        Break
#      Next
#
#    Next
#
#    #We have more than one default address, so clear fields to force user to select one
#    [M:BIS1]BPAPAY = ""
#    [M:BIS1]YBPAYREF = ""
#    [M:BIS1]YBILLCOD = ""
#
#  Else
#    #We have no default address, so clear fields
#    [M:BIS1]BPAPAY = ""
#    [M:BIS1]YBPAYREF = ""
#    [M:BIS1]YBILLCOD = ""
#  Endif
#
#Next

Affzo [M:BIS1]BPAPAY,YBPAYREF,YBILLCOD
#DFCX1-49 Supplier Bank Account - End

End

######################################################################################
#------------------------------------------------------------------------------------#
#Control - Validate Project Link DFCX1-153
#------------------------------------------------------------------------------------#
Subprog C_PJTH(VALEUR)
Variable Char    VALEUR
  If VALEUR <> '' and GWEBSERV = 0

    Local Integer I : I = 0
    Local Char REQUEST(255)(15)

    REQUEST(0) = "SELECT t1.OPPNUM_0, t0.PBUCOD_0, t2.TEXTE_0, t3.LANMES_0, t0.FCY_0, t0.PIMNUM_0, t4.LANMES_0"
    REQUEST(1) -= "FROM PIMPL t0"
    REQUEST(2) -= "JOIN PJMBUD t1 ON t0.OPPNUM_0 = t1.OPPNUM_0 AND t0.PBUCOD_0 = t1.PBUCOD_0"
    REQUEST(3) -= "JOIN ATEXTRA t2 ON t0.OPPNUM_0 = t2.IDENT1_0 AND t2.ZONE_0 = 'PIMDESAXX' AND t2.LANGUE_0 = 'ENG' AND t2.CODFIC_0 = 'PIMPL'"
    REQUEST(4) -= "JOIN APLSTD t3 ON t0.PIMTYP_0 = t3.LANNUM_0 AND t3.LAN_0 = 'ENG' AND t3.LANCHP_0 = 2254"
    REQUEST(5) -= "JOIN APLSTD t4 ON t0.PIMSTA_0 = t4.LANNUM_0 AND t4.LAN_0 = 'ENG' AND t4.LANCHP_0 = 2249"
    REQUEST(6) -= "WHERE"

    #Project Status = Launched
    REQUEST(7) -= "t0.OPPSTATE_0 = 2"

    #Site
    REQUEST(8) -= "AND t0.FCY_0 = '" + [M:BIS0]FCY + "'"

    #Active = Yes
    REQUEST(9) -= "AND t0.PIMSTA_0 = 2"

    #Chargeable = Yes
    REQUEST(10) -= "AND t1.PBUIMP_0 = 2"

    #Budget Status = Open
    REQUEST(11) -= "AND t0.PBUSTATE_0 = 2"

    #Project Link entered
    REQUEST(12) -= "AND t0.PIMNUM_0 = '" + VALEUR + "'"

    For (Char OPPNUM(20), Char PBUCOD(15), Char TEXTE(30), Char PIMTYP(123), Char FCY(5), Char PIMNUM(40), Char PIMSTA(123)) From "5" Sql REQUEST As [YPRJLNK]
      I += 1
      Break
    Next

    If I = 0
      #No record found
      Call ERRTIT("Record not found", "Project") From GESECRAN
      Raz [M:BIS1]PJTH
      Affzo [M:BIS1]PJTHYJBNR
      mkstat=2
    Endif

  Endif
End

######################################################################################
#------------------------------------------------------------------------------------#
#After Change - Validate Bank DFCX1-47
#------------------------------------------------------------------------------------#
Subprog AM_YPAYBANK(VALEUR)
Variable Char    VALEUR()

If VALEUR <> ""

  Local Integer I : I = 0
  Local Char REQUEST(255)
  REQUEST = "SELECT BAN_0 FROM BANK WHERE CPY_0 = '" + [M:BIS0]CPY + "' AND FCY_0 = '" + [M:BIS0]FCY + "' AND BAN_0 = '" + VALEUR + "' AND YSTA_0 = 2"

  For (Char BANK(50)) From "5" Sql REQUEST As [YBANK]
    I += 1
    Break
  Next

  If I = 0
    #No record found
    Call ERRTIT("Record not found or invalid for this Site", "Bank") From GESECRAN
    Raz [M:BIS1]YPAYBANK
    Affzo [M:BIS1]YPAYBANK
    mkstat=2
  Endif

Endif

End


######################################################################################

