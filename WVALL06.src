#<AdxTL>@(#)%|%Algorithme pour règle d'allocationALL06
#-----------------------------------------------------------------
# WVALL06                                         04/05/2018
#-----------------------------------------------------------------
$TRT_ALLOC
Local Date WDATMAX : WDATMAX=[31/12/2100]
For I=0 To [M]NBLIG-1
  If [M]ECCVALMAJ=''
    [M]WCOND(I)=string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP),
&               [M]WINCLOT(I)+'A1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'A2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'B1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'B2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'C1'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'C2'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +'9999Z'
  Else
    [M]WCOND(I)=string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ,
&               [M]WINCLOT(I)+'A1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'A2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'B1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'B2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'C1'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WECCVALMAJ(I)=[M]ECCVALMAJ&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'C2'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP),
&               [M]WINCLOT(I)+'K1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]PCU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'K2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'L1'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)=[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'L2'+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),[M]LOC)|pat([M]WLOCTYP(I),[M]LOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'M1'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +string$(left$([M]WSTA(I),1)='A'&[M]WPCU(I)<>[M]STU&pat([M]WLOC(I),WDEFLOC)&pat([M]WLOCTYP(I),WDEFLOCTYP)&[M]WCOND(I)='',
&               [M]WINCLOT(I)+'M2'+format$('N0:12',10^6*[M]WPCUSTUCOE(I))+format$('D:4YMMDD',[M]WLOTCREDAT(I)))
&               +'9999Z'
  Endif
Next I

# Tri du tableau sur deux colonnes seulement pour raisons de performance
Sorta [M]NBLIG [M]WCOND,[M]NLIG
[M]NBLIG=sigma(0,[M]NBLIG-1,[M]WCOND(indcum)<'9999Z')
# Si gestion dépôt et dépôt préférentiel renseigné
If GWRHACT=2 & !find(LWRH,'','*')
   For I=0 To [M]NBLIG-1
      If pat([M]WWRH(I),LWRH)
         [M]WCOND(I)='1'+[M]WCOND(I)
      Else
         [M]WCOND(I)='9'+[M]WCOND(I)
      Endif
   Next I
Endif
# Si propriétaire
If [M]PECOWNER<>''
   For I=0 To [M]NBLIG-1
      If [M]WCOND(I)='9999Z'
         [M]WCOND(I)='9'+[M]WCOND(I)
      Else
         [M]WCOND(I)=[M]WOWN(I)+[M]WCOND(I)
      Endif
   Next I
Endif
Return
