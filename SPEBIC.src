#<AdxTL>@(#)0.0.0.0 $Revision$
######################################################################################################################
# Script            : SPEBIC                                                                                         #
# Creation date     : 11/01/2019                                                                                     #
# Version           : 1.0.0                                                                                          #
# Authors (Company) : LT (Leverage Technology)                                                                       #
# Module            : A/P-A/R accounting                                                                             #
# -------------------------------------------------------------------------------------------------------------------#
# Epic              :                                                                                                #
#--------------------------------------------------------------------------------------------------------------------#
# Evolutions        :                                                                                                #
######################################################################################################################
$ACTION
Case ACTION
  When "OUVRE"      : Gosub OUVRE
  When "INICRE"     : Gosub INICRE
  When "RAZCRE"     : Gosub RAZCRE
  When "RAZDUP"     : Gosub RAZDUP
  When "APRES_CRE"  : Gosub APRES_CRE
  When "VERIF_CRE"  : Gosub VERIF_CRE
  When "VERIF_MOD"  : Gosub VERIF_MOD
  When "STYLE"      : Gosub STYLE
  When "SETBOUT"    : Gosub SETBOUT
  When Default
Endcase
Return

#------------------------------------------------------------------------------------#
#Open needed tables
#------------------------------------------------------------------------------------#
$OUVRE

If clalev([F:YGAC])   = 0 : Local File GACCOUNT   [YGAC]  : Endif
If clalev([F:YCCE])   = 0 : Local File CACCE      [YCCE]  : Endif
If clalev([F:YCPY])   = 0 : Local File COMPANY    [YCPY]  : Endif
If clalev([F:YGACM])  = 0 : Local File GACM       [YGACM] : Endif
If clalev([F:YGLED])  = 0 : Local File GLED       [YGLED] : Endif
If clalev([F:YBPC])   = 0 : Local File BPCUSTOMER [YBPC]  : Endif
If clalev([F:YVAC])   = 0 : Local File TABVACBPR  [YVAC]  : Endif

Return

#------------------------------------------------------------------------------------#
#Do validations before create
#------------------------------------------------------------------------------------#
$INICRE
If func AFNC.ACTIV("YPJM") = 1
  Gosub VALIDATEPJM
Endif
Return

#------------------------------------------------------------------------------------#
#Do validations before creation
#------------------------------------------------------------------------------------#
$VERIF_CRE

#DFCX1-337 Update Amount - GST header amount to supress "Totals different from header" warning message when creating / updating record
[M:BIC1]AMTNOT = sum([M]AMTNOTLIN(0..[M]NBLIG-1))
Affzo [M:BIC1]AMTNOT

Return


#------------------------------------------------------------------------------------#
#Do validations before modifications
#------------------------------------------------------------------------------------#
$VERIF_MOD
If func AFNC.ACTIV("YPJM") = 1
  Gosub VALIDATEPJM
  GOK = 0
Endif

#DFCX1-337 Update Amount - GST header amount to supress "Totals different from header" warning message when creating / updating record
[M:BIC1]AMTNOT = sum([M]AMTNOTLIN(0..[M]NBLIG-1))
Affzo [M:BIC1]AMTNOT

Return


#------------------------------------------------------------------------------------#
#Do actions after creation
#------------------------------------------------------------------------------------#
$APRES_CRE
  #DFCX1-71 - Write-back Document number to Housing Job Stage if allocated to a Housing Job and Stage number
  If func AFNC.ACTIV("YHOU") = 1
    #Only for manually created documents
    If GWEBSERV = 0 and [F:SIH]NUM <> ""
      If [M:BIC0]YJBNR <> "" and [M:BIC0]YSTANBR > 0
        #Update Staging Record
        If !clalev ([F:YHJS])   : Local File YHOUJSTA   [F:YHJS]  : Endif

        Read [F:YHJS]YHJS0 = [M:BIC0]YJBNR;[M:BIC0]YSTANBR

        If fstat = 0

          [F:YHJS]YINVNUM = [F:SIH]NUM
          [F:YHJS]YAMTCLM = [F:SIH]AMTATI
          [F:YHJS]YDATCLM = [F:SIH]ACCDAT

          Rewrite [F:YHJS]

          If fstat <> 0
            Infbox("Failed to update Housing Job Stage")
          Endif

        Endif

        If clalev([F:YHJS])     : Close Local File [F:YHJS]     : Endif

      Endif
    Endif
  Endif
Return
#------------------------------------------------------------------------------------#
#Do validations before create
#------------------------------------------------------------------------------------#
$RAZCRE
  #DFCX1-71 - Disable the Job Number, Stage Number, and Supress Statement Printing for Housing Jobs
  If func AFNC.ACTIV("YHOU") = 1
    Diszo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
    Affzo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
  Endif
Return


#------------------------------------------------------------------------------------#
#Do validations before duplication
#------------------------------------------------------------------------------------#
$RAZDUP
  #DFCX1-71 - Disable the Job Number, Stage Number, and Supress Statement Printing for Housing Jobs
  If func AFNC.ACTIV("YHOU") = 1

    Raz [M:BIC0]YJBNR,YSTANBR,YSTASUPP

    If [M:BIC0]SIVTYP = "HINV" or [M:BIC0]SIVTYP = "HCRN"
      Actzo [M:BIC0]YJBNR,YSTANBR
    Else
      Diszo [M:BIC0]YJBNR,YSTANBR
    Endif

    Diszo [M:BIC0]YSTASUPP
    Affzo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
  Endif
Return

#------------------------------------------------------------------------------------#
#Set Buttons
#------------------------------------------------------------------------------------#
$SETBOUT
  #DFCX1-72 - Disable the Delete link for Housing Job Invoices and Credit Notes
  If func AFNC.ACTIV("YHOU") = 1
    #Hide Delete button if its not called by a Web Service
    If GWEBSERV = 0
      If [M:BIC0]SIVTYP = "HINV" or [M:BIC0]SIVTYP = "HCRN"
        Call VIREBOUT(CHAINE,"A") From GOBJET
      Endif
    Endif
  Endif
Return


#------------------------------------------------------------------------------------#
#Do validations after record is displayed
#------------------------------------------------------------------------------------#
$STYLE
  #DFCX1-71 - Disable the Job Number and Stage Number fields for Housing Jobs
  If func AFNC.ACTIV("YHOU") = 1
    Diszo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
    Affzo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
  Endif
  #DFCX1-153 - DW -  the user must be unable to selected Project Header - Start
  If func AFNC.ACTIV("YPJM") = 1
    If dim([M:BIC1]PJTH)>0 : Chgfmt [M:BIC1]PJTH With "-K:40X" : Raz [M:BIC1]PJTH : Endif
  Endif
  #DFCX1-153 - DW -  the user must be unable to selected Project Header - End
Return


#------------------------------------------------------------------------------------#
#Perform PJM account link validations
#------------------------------------------------------------------------------------#
$VALIDATEPJM

Local Char YMSG(250)

  For I = 0 To [M:BIC3]NBLIG-1

  Filter [F:YGAC] Where ACC = [M:BIC3]ACC1(I)
  For [F:YGAC]

  If [F:YGAC]YPJM = 2 and [M:BIC3]PJTLIN(I) = ""
    YMSG += num$(I + 1) + ", "
  Endif

  Next
  Filter [F:YGAC]

  Next

  If len(YMSG) > 0
    GMESSAGE = mess(2,6201,1) + left$(YMSG,len(YMSG)-2) # "Please enter a project code on the following lines: " + ZMSG
    GERR = 1
    GOK = 0
  Endif

Return#------------------------------------------------------------------------------------#
#After change - SINVTYP
#------------------------------------------------------------------------------------#
Subprog AM_SIVTYP(VALEUR)
Variable Char    VALEUR
  #DFCX1-71 - Disable the Job Number and Stage Number fields for Housing Jobs
  If func AFNC.ACTIV("YHOU") = 1
    If VALEUR = "HINV" or VALEUR = "HCRN"
      Actzo [M:BIC0]YJBNR,YSTANBR
    Else
      Raz [M:BIC0]YJBNR,YSTANBR
      Diszo [M:BIC0]YJBNR,YSTANBR
    Endif
    #Enable the Supress printing field if its web services to enable editing value
    If GWEBSERV = 0
      Diszo [M:BIC0]YSTASUPP
    Else
      Actzo [M:BIC0]YSTASUPP
    Endif
    Affzo [M:BIC0]YJBNR,YSTANBR,YSTASUPP
  Endif
End


#------------------------------------------------------------------------------------#
#Control - BPR
#------------------------------------------------------------------------------------#
Subprog C_BPR(VALEUR)
Variable Char    VALEUR()

#DFCX1-71
If func AFNC.ACTIV("YBPR") = 1
  Call C_BPRSEL(VALEUR) From YSELBPC
Endif

End


#------------------------------------------------------------------------------------#
#Control - YJBNR
#------------------------------------------------------------------------------------#
Subprog C_YJBNR(VALEUR)
Variable Char    VALEUR
#DFCX1-71
If func AFNC.ACTIV("YHOU") = 1
  If VALEUR <> '' and GWEBSERV = 0

    Local Integer I : I = 0
    Local Char REQUEST(255)

    REQUEST(0) = "SELECT t0.YJBNR_0, t0.YJBTYP_0, t0.YHOUTYP_0 FROM YHOUJDET t0"
    REQUEST(0) -= "JOIN CACCE t1 ON t0.YJBNR_0 = t1.CCE_0 AND t1.DIE_0 = 'HJB' AND t1.ENAFLG_0 = 2"
    REQUEST(0) -= "WHERE UPPER(t0.YJBNR_0) = UPPER('" + VALEUR + "') AND t0.YCUSNO_0 = '" + [M:BIC0]BPR + "'"

    For (Char YJOBNUM(15), Char YJOBTYP(20), Char YHOUTYP(50)) From "5" Sql REQUEST As [YLNK]
      I += 1
      Break
    Next

    If I = 0
      #No record found
      Call ERRTIT(func AFNC.MES1(mess(6,6251,1), "Housing Job Number"), "Mandatory field") From GESECRAN
      Raz [M:BIC0]YJBNR
      Affzo [M:BIC0]YJBNR
      mkstat=2
    Endif

  Endif
Endif
End


#------------------------------------------------------------------------------------#
#Control - YSTANBR
#------------------------------------------------------------------------------------#
Subprog C_YSTANBR(VALEUR)
Variable Decimal    VALEUR
#DFCX1-71
If func AFNC.ACTIV("YHOU") = 1
  If VALEUR <> 0 and GWEBSERV = 0
    Local Integer I : I = 0
    Local Char REQUEST(255)(1..2)

    REQUEST(1) = "SELECT t0.YSTANBR_0, t0.YSTAGENAM_0, t0.YINVNUM_0 FROM YHOUJSTA t0"
    REQUEST(1) -= "JOIN CACCE t1 ON t0.YJBNR_0 = t1.CCE_0 AND t1.DIE_0 = 'HJB' AND t1.ENAFLG_0 = 2"
    REQUEST(1) -= "WHERE t0.YSTANBR_0 = " + num$(VALEUR) + " AND t0.YJBNR_0 = '" + [M:BIC0]YJBNR + "'"

    If [M:BIC0]SIVTYP = "HINV"
      REQUEST(2) -= "AND t0.YDATCLM_0 = '1753-01-01' and t0.YINVNUM_0 = '' and t0.YAMTCLM_0 = 0 and t0.YACTCMPDAT_0 <> '1753-01-01'"
    Elsif [M:BIC0]SIVTYP = "HCRN"
      REQUEST(2) -= "AND t0.YINVNUM_0 <> ''"
    Endif
    REQUEST(2) -= "ORDER BY 1"

    For (Integer YSTAGE, Char YSTAGNAME(50), Char YINVNO(50)) From "5" Sql REQUEST As [YLNK]
      I += 1
      #[M:BIC1]INVNUM = [YLNK]YINVNO
      #Affzo [M:BIC1]INVNUM
      Break
    Next

    If I = 0
      #No record found
      Call ERRTIT(func AFNC.MES1(mess(6,6251,1), "Housing Job Stage"), "Mandatory field") From GESECRAN
      Raz [M:BIC0]YSTANBR
      Affzo [M:BIC0]YSTANBR
      mkstat=2
    Endif

  Endif
Endif

End


#--------------------------------------------------------------
# Before field - ACC1
#--------------------------------------------------------------
Subprog AS_ACC1(VALEUR)
Variable Char    VALEUR()

  #DFCX1-291 Default the Project GL Account if we have a Project on the header
  If VALEUR = "" and [M:BIC1]PJTH <> ""

    If !clalev ([F:YOPJM])   : Local File OPPORPJM   [F:YOPJM]  : Endif
    If !clalev ([F:YOPJL])   : Local File PIMPL      [F:YOPJL]  : Endif
    If !clalev ([F:YOPJB])   : Local File PJMBUDLIG  [F:YOPJB]  : Endif

    #Read Project Number from Project Link
    Read [F:YOPJL]PIM0 = [M:BIC1]PJTH

    If fstat = 0

      #Read Project
      Read [F:YOPJM]OPPPJM0 = [F:YOPJL]OPPNUM

      If fstat = 0

        #Default GL Account if found on Project, otherwise use Customer Default GL account
        If [F:YOPJM]YDEFACC <> ""
          VALEUR = [F:YOPJM]YDEFACC
        Else
          #VALEUR = [F:BPC]YDEFGL
        Endif

      Endif
    Endif

    If clalev([F:YOPJM])     : Close Local File [F:YOPJM]       : Endif
    If clalev([F:YOPJL])     : Close Local File [F:YOPJL]       : Endif
    If clalev([F:YOPJB])     : Close Local File [F:YOPJB]       : Endif

  Else
    #Default GL Account when no Project specified on header
    #VALEUR = [F:BPC]YDEFGL
  Endif

End


#--------------------------------------------------------------
# Before entry - VAT
#--------------------------------------------------------------
Subprog AS_VAT(VALEUR)
Variable Char    VALEUR()
  VALEUR = [M:BIC1]VAC
End


#--------------------------------------------------------------
# Before Entry - AMTATILIN
#--------------------------------------------------------------
Subprog AS_AMTATILIN(VALEUR)
Variable Decimal VALEUR

  #Set Amount + GST on grid line equal to remaining amount (Header amount GST - total lines)
  If VALEUR = 0 and GWEBSERV = 0
    If [M:BIC1]AMTATI - sum([M:BIC3]AMTATILIN(0..[M:BIC3]NBLIG-1)) > 0
      VALEUR = [M:BIC1]AMTATI - sum([M:BIC3]AMTATILIN(0..[M:BIC3]NBLIG-1))
    Endif
  Endif

End


#------------------------------------------------------------------------------------#
#Control - PJTLIN
#------------------------------------------------------------------------------------#
Subprog C_PJTLIN(VALEUR)
Variable Char    VALEUR()

#Check if Project is mandatory and has no value, set focus to the Project field
If VALEUR = "" and [M:BIC3]ACC1(nolign-1) <> ""

  Read [F:YGAC]GAC0 = GPLAN(1);[M:BIC3]ACC1(nolign-1)

  If fstat = 0

    If [F:YGAC]YPJM = 2 and VALEUR = ""

      GMESSAGE = "Account " + [M:BIC3]ACC1(nolign-1) + "  requires a Project"
      GERR = 1
      GOK = 0

      mkstat=2

    Endif

  Endif

Endif

End


#--------------------------------------------------------------
# Before field - CCE1
#--------------------------------------------------------------
Subprog AS_CCE1(VALEUR)
Variable Char    VALEUR()

  #DFCX1-50 Default the Project, Business Group, Job, and Cost Center based on selected header Project code
  If VALEUR = "" and [M:BIC3]PJTLIN(nolign-1) <> ""

    If !clalev ([F:YOPJM])   : Local File OPPORPJM   [F:YOPJM]  : Endif
    If !clalev ([F:YOPJL])   : Local File PIMPL      [F:YOPJL]  : Endif
    If !clalev ([F:YOPJB])   : Local File PJMBUDLIG  [F:YOPJB]  : Endif

    #Read Project Number from Project Link
    Read [F:YOPJL]PIM0 = [M:BIC3]PJTLIN(nolign-1)

    If fstat = 0

      #Read Project
      Read [F:YOPJM]OPPPJM0 = [F:YOPJL]OPPNUM

      If fstat = 0
        VALEUR = [F:YOPJM]CCE(0)
      Endif

    Endif

    If clalev([F:YOPJM])     : Close Local File [F:YOPJM]       : Endif
    If clalev([F:YOPJL])     : Close Local File [F:YOPJL]       : Endif
    If clalev([F:YOPJB])     : Close Local File [F:YOPJB]       : Endif

  Endif

End


#--------------------------------------------------------------
# After change - CCE1
#--------------------------------------------------------------
Subprog AM_CCE1(VALEUR)
Variable Char    VALEUR()
  If VALEUR <> "" and GWEBSERV=0
    Call VALIDATE_CCE(VALEUR,[M]DIE(0),"DIE_0")
  Endif
End


#--------------------------------------------------------------
# Before field - CCE2
#--------------------------------------------------------------
Subprog AS_CCE2(VALEUR)
Variable Char    VALEUR()
End


#--------------------------------------------------------------
# After change - CCE2
#--------------------------------------------------------------
Subprog AM_CCE2(VALEUR)
Variable Char    VALEUR()
  If VALEUR <> "" and GWEBSERV=0
    Call VALIDATE_CCE(VALEUR,[M]DIE(1),"DIE_1")
  Endif
End


#--------------------------------------------------------------
# Before field - CCE3
#--------------------------------------------------------------
Subprog AS_CCE3(VALEUR)
Variable Char    VALEUR()

  #DFCX1-50 Default the Project, Business Group, Job, and Cost Center based on selected header Project code
  If VALEUR = "" and [M:BIC3]PJTLIN(nolign-1) <> ""

    If !clalev ([F:YOPJM])   : Local File OPPORPJM   [F:YOPJM]  : Endif
    If !clalev ([F:YOPJL])   : Local File PIMPL      [F:YOPJL]  : Endif
    If !clalev ([F:YOPJB])   : Local File PJMBUDLIG  [F:YOPJB]  : Endif

    #Read Project Number from Project Link
    Read [F:YOPJL]PIM0 = [M:BIC3]PJTLIN(nolign-1)

    If fstat = 0

      #Read Project
      Read [F:YOPJM]OPPPJM0 = [F:YOPJL]OPPNUM

      If fstat = 0
        VALEUR = [F:YOPJM]CCE(2)
      Endif

    Endif

    If clalev([F:YOPJM])     : Close Local File [F:YOPJM]       : Endif
    If clalev([F:YOPJL])     : Close Local File [F:YOPJL]       : Endif
    If clalev([F:YOPJB])     : Close Local File [F:YOPJB]       : Endif

  Endif

End


#--------------------------------------------------------------
# After change - CCE3
#--------------------------------------------------------------
Subprog AM_CCE3(VALEUR)
Variable Char    VALEUR()
  If VALEUR <> "" and GWEBSERV=0
    Call VALIDATE_CCE(VALEUR,[M]DIE(2),"DIE_2")
  Endif
End

#--------------------------------------------------------------
# Before field - CCE4
#--------------------------------------------------------------
Subprog AS_CCE4(VALEUR)
Variable Char    VALEUR()

  #DFCX1-50 Default the Project, Business Group, Job, and Cost Center based on selected header Project code
  If VALEUR = "" and [M:BIC3]PJTLIN(nolign-1) <> ""

    If !clalev ([F:YOPJM])   : Local File OPPORPJM   [F:YOPJM]  : Endif
    If !clalev ([F:YOPJL])   : Local File PIMPL      [F:YOPJL]  : Endif
    If !clalev ([F:YOPJB])   : Local File PJMBUDLIG  [F:YOPJB]  : Endif

    #Read Project Number from Project Link
    Read [F:YOPJL]PIM0 = [M:BIC3]PJTLIN(nolign-1)

    If fstat = 0

      #Read Project budget
      Read [F:YOPJB]PJLB0 = [F:YOPJL]OPPNUM;[F:YOPJL]PBUCOD;10

      If fstat = 0
        VALEUR = [F:YOPJB]PCCCOD #Cost centre
      Endif

    Endif

    If clalev([F:YOPJM])     : Close Local File [F:YOPJM]       : Endif
    If clalev([F:YOPJL])     : Close Local File [F:YOPJL]       : Endif
    If clalev([F:YOPJB])     : Close Local File [F:YOPJB]       : Endif

  Endif

End


#--------------------------------------------------------------
# After change - CCE4
#--------------------------------------------------------------
Subprog AM_CCE4(VALEUR)
Variable Char    VALEUR()
  If VALEUR <> "" and GWEBSERV=0
    Call VALIDATE_CCE(VALEUR,[M]DIE(3),"DIE_3")
  Endif
End


#--------------------------------------------------------------
# Before field - CCE5
#--------------------------------------------------------------
Subprog AS_CCE5(VALEUR)
Variable Char    VALEUR()
End


#--------------------------------------------------------------
# After change - CCE5
#--------------------------------------------------------------
Subprog AM_CCE5(VALEUR)
Variable Char    VALEUR()
  If VALEUR <> "" and GWEBSERV=0
    Call VALIDATE_CCE(VALEUR,[M]DIE(4),"DIE_4")
  Endif
End


#--------------------------------------------------------------
# Validate entered grid dimension
#--------------------------------------------------------------
Subprog VALIDATE_CCE(CCE,DIE_VAL,DIE_FLD)

Variable Char CCE
Value Char DIE_VAL,DIE_FLD
Local Char REQUEST(255)(10)
Local Integer I

REQUEST(0) = "SELECT COUNT(*)"
REQUEST(1) -= "FROM FACILITY t0"
REQUEST(2) -= "JOIN COMPANY t1 ON t0.LEGCPY_0 = t1.CPY_0"
REQUEST(3) -= "JOIN GACM t2 ON t1.ACM_0 = t2.GCM_0"
REQUEST(4) -= "JOIN GLED t3 ON t2.LED_0 = t3.LED_0"
REQUEST(5) -= "INNER JOIN CACCE t4 ON t4.DIE_0 = t3." + DIE_FLD
REQUEST(6) -= "LEFT OUTER JOIN YPCCACC t5 ON t5.YLED_0 = t3.LED_0 AND t5.YDIE_0 = t4.DIE_0 AND t5.YCCE_0 = t4.CCE_0"
REQUEST(7) -= "WHERE t4.DIE_0 = '" + DIE_VAL +"' AND ((t5.YACC_0 = '" + [M:BIC3]ACC1(nolign-1) +
& "' AND t5.YLED_0 = t3.LED_0) OR (t5.YACC_0 IS NULL AND t5.YLED_0 IS NULL)) AND t4.CCE_0 = '" + CCE + "' AND t4.ENAFLG_0 = 2"

For (Integer COUNT) From "5" Sql REQUEST As [YDIE]
  I = [YDIE]COUNT
Next

If I < 1
  GMESSAGE = mess(6,6201,1)
  GERR = 1
  mkstat = 2
Endif

End

