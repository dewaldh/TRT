#<AdxTL>@(#)0.0.0.0 $Revision$
# Supervisor
# Object management MFC

$HORODAT
Local Date    A_DATE
Local Char    A_HEURE(10) , A_USER(10)
Local Char    A_STAMP(15)
A_DATE  = [28/08/2018]
A_HEURE = "00:31:38"
A_USER  = "ADMIN"
A_STAMP = "20180828003138"
Return

$DEFAUT
Default File [MFC]
Return

$OUVFIC
Local File MFGCOST [MFC]
Return

$NOMFIC
Local Integer NBLNK , TITLNK(1..20)
Local Char    OBJLNK(GLONAOB)(1..20) , CODLNK(GLONADI)(1..20)
Local Char    DESLNK(20)(1..20) , ABRLNK(GLONABR)(1..20)
Local Integer NUMLNK(1..20) , LIGLNK(1..20)
Local Char    NOMFIC(GLONATB) , ABFIC(GLONABR) , ABTAB(GLONABR) , NOMINT(GLONAVA)
Local Integer TYPGES , FLGSTAT , SELORD , TYPOBJ
Local Char    ZSITE(GLONAVA), ZACC(GLONAVA), FLDGRF(GLONAVA), FLDLEG(GLONAVA), FLDGRC(GLONAVA)
Local Char    REPORT1(GLONARP) , REPORT2(GLONARP) , NOMKEY(GLONAVA)
Local Integer DELDEF, FCYREQ
Local Char    SELIND(250) , ADDURL(250)
NOMFIC = "MFGCOST"
ABFIC  = "MFC"
ABTAB  = "MFC"
NOMINT = ""
TYPGES = 1
SELORD = 1
ZSITE  = "STOFCY"
ZACC   = ""
FLDGRF = ""
FLDGRC = ""
FLDLEG = ""
FCYREQ = 1
PPAG   = 0
SELIND = "[F:MFC]STOFCY;[F:MFC]ITMREF;[F:MFC]VCRTYP;[F:MFC]VCRNUM;[F:MFC]VCRLIN;[F:MFC]MFCTYP;[F:MFC]UID"
DELDEF = 1
ADDURL = ""
REPORT1 = "MFGCOST"
NOMKEY = "MFC0"
FLGSTAT = 0
TITOBJ = 8880
NBLNK = 0
Raz NUMLNK , LIGLNK
Return

$OUVRE
If clalev([F:ITF])=0 : Local File ITMFACILIT   [ITF] : Endif
If clalev([F:ITM])=0 : Local File ITMMASTER    [ITM] : Endif
If clalev([F:TCU])=0 : Local File TABCUR       [TCU] : Endif
If clalev([F:ITG])=0 : Local File ITMCATEG     [ITG] : Endif
If clalev([F:SCI])=0 : Local File SCOITM       [SCI] : Endif
If clalev([F:AFF])=0 : Local File AFCTFCY    [AFF] : Endif
Return

$ESPION
NUMESPION = 1
Return

$TIT
Local Char TIT(60)
Call TEXTE(8880,TIT) From OBJDIV
Return

$SETCLE
Local Char CLEPRIM(GLONAVA) , CLESEC(GLONAVA)(0..5) , CLELIG(GLONAVA)
CLEPRIM = 'ITMREF'
CLESEC(0) = 'STOFCY'
CLESEC(1) = 'VCRTYP'
CLESEC(2) = 'VCRNUM'
CLESEC(3) = 'VCRLIN'
CLESEC(4) = 'MFCTYP'
CLESEC(5) = 'UID'
Return

$OPTIONS
Local Integer  NBCOND
Local Char     CONDIT(50)(1..20)
Local Char     OPT(1)(1..20) , OPTSEL(20)
Local Char     LIBOPT(30)(1..20), MESSAG(80)(1..20)
NBCOND = 0
NBCOND += 1
OPT(NBCOND)    = 'F'
CONDIT(NBCOND) = "VCRTYP=10"
Call TEXTE(26845,LIBOPT(NBCOND)) From OBJDIV
Call TEXTE(0,MESSAG(NBCOND)) From OBJDIV
NBCOND += 1
OPT(NBCOND)    = 'S'
CONDIT(NBCOND) = "VCRTYP=36"
Call TEXTE(27223,LIBOPT(NBCOND)) From OBJDIV
Call TEXTE(0,MESSAG(NBCOND)) From OBJDIV
OPTSEL = ''
Return

$LIBPAR
Local Char LIBPAR(30)
Call TEXTE(0,LIBPAR) From OBJDIV
Return

$OUVFIC_DERLU
Local Decimal  A_BUFI(0..GNBDERNIER)
Local Char     A_BUFC(200)(0..GNBDERNIER)
Local Char     A_BUF1(5)(0..GNBDERNIER)
Local Char     A_BUF2(20)(0..GNBDERNIER)
Local Shortint A_BUF3(0..GNBDERNIER)
Local Char     A_BUF4(20)(0..GNBDERNIER)
Local Char     A_BUF5(40)(0..GNBDERNIER)
Local Libelle  A_BUF6(0..GNBDERNIER)
Local Integer  A_BUF7(0..GNBDERNIER)
Local Integer  A_BUF8(0..GNBDERNIER)
If clalev([F:MFC9])>0 : Close Local File [MFC9] : Endif
Local File (
& Decimal  A_TABI,
& Char     A_TABC(200),
& Char     A_TAB1(5),
& Char     A_TAB2(20),
& Shortint A_TAB3,
& Char     A_TAB4(20),
& Char     A_TAB5(40),
& Libelle  A_TAB6,
& Integer  A_TAB7,
& Integer  A_TAB8
& ) From Variable A_BUFI,A_BUFC,A_BUF1,A_BUF2,A_BUF3,A_BUF4,A_BUF5,A_BUF6,A_BUF7,A_BUF8
& As [MFC9]
Return

$LEC_DERLU
Read [AFF]AFF0 = [F:MFC]STOFCY;GPROFIL;GUSRFCT
If fstat : Raz [F:AFF] : Endif
Return

$CHARGE_DERLU
If clalev([F:MFC9])>0
 Read [MFC9] = [F:MFC9]A_TABI
 [L]CLE = [F:MFC9]A_TABC
Endif
Return

$REMP_DERLU
If clalev([F:MFC9])>0
 Filter [MFC9]
& Where A_TABI<>0
& Order by A_TABI
 Fillbox [MFC1] GAU_CHE9
Endif
Return

$CLE_DERLU
If clalev([F:MFC9])>0
 Local Integer A_IND
 Local Char    A_CLEDERLU(200)
 A_CLEDERLU = ""
 A_CLEDERLU = [F:MFC]ITMREF+"~"
 A_CLEDERLU += [F:MFC]STOFCY+"~"
 A_CLEDERLU += num$([F:MFC]VCRTYP)+"~"
 A_CLEDERLU += [F:MFC]VCRNUM+"~"
 A_CLEDERLU += num$([F:MFC]VCRLIN)+"~"
 A_CLEDERLU += num$([F:MFC]MFCTYP)+"~"
 A_CLEDERLU += num$([F:MFC]UID)+"~"
 A_IND = find(A_CLEDERLU,A_BUFC)
 If A_IND
  [F:MFC9]A_TABI = A_BUFI(A_IND-1)
 Else
  Raz [F:MFC9]
 Endif
Endif
Return

$OUVRE_LISTE
Local Integer NBSEL , NBTRI , SELCAR
Local Char    SELZON(30)(0..16)
Local Char    SELEXP(200)(0..16)
Local Char    SELLIB(30)(0..16)
Local Char    SELFMT(30)(0..16)
Local Schar   SELFOR(30)(0..16)
Local Integer SELTYP(0..16)
Local Integer SELMAJ(0..16)
Local Char    TRIZON(20)(0..16)
Local Char    TRILIB(30)(0..16)
SELCAR = 0
NBSEL = 0 : NBTRI = 0
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]STOFCY"
Call TEXTE(1720,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 7
SELFMT(NBSEL) = "K:5X"
SELFOR(NBSEL) = "K:5c"
SELMAJ(NBSEL) = 1
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]STOFCY"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]ITMREF"
Call TEXTE(3651,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 7
SELFMT(NBSEL) = "K:20X"
SELFOR(NBSEL) = "K:20X"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]ITMREF"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]YEA"
Call TEXTE(1879,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 2
SELFMT(NBSEL) = "N:4F"
SELFOR(NBSEL) = "N:4#"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]YEA"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]VCRNUM"
Call TEXTE(7736,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 7
SELFMT(NBSEL) = "K:20X"
SELFOR(NBSEL) = "K:20X"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]VCRNUM"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]PJT"
Call TEXTE(1886,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 7
SELFMT(NBSEL) = "K:40X"
SELFOR(NBSEL) = "K:40X"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]PJT"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]MFCTYP"
Call TEXTE(20138,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 1
SELFMT(NBSEL) = "LA02355:15X"
SELFOR(NBSEL) = ""
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]MFCTYP"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]VCRLIN"
Call TEXTE(5300,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 3
SELFMT(NBSEL) = "N:8F"
SELFOR(NBSEL) = "N:8#"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]VCRLIN"
TRILIB(NBTRI) = SELLIB(NBSEL)
NBSEL += 1
SELZON(NBSEL) = "[F:MFC]UID"
Call TEXTE(5274,SELLIB(NBSEL)) From OBJDIV
SELTYP(NBSEL) = 3
SELFMT(NBSEL) = "N:8F"
SELFOR(NBSEL) = "N:8#"
SELMAJ(NBSEL) = 0
NBTRI += 1
TRIZON(NBTRI) = "[F:MFC]UID"
TRILIB(NBTRI) = SELLIB(NBSEL)
If clalev([F:MFC_])=0
 Gosub OUVFIC_LISTE
Endif
Return

$OUVFIC_LISTE
If clalev([F:AFF])=0 : Local File AFCTFCY  [AFF] : Endif
If clalev([F:SCI])=0 : Local file SCOITM [SCI] : Endif
Link [MFC] With
& [AFF]AFF0~=[F:MFC]STOFCY;GPROFIL;GUSRFCT,
& [SCI]SCI0=[F:MFC]VCRNUM;[F:MFC]VCRLIN
& As [MFC_]
Return

$DEFAUT_LISTE
Default file [MFC_]
Return

$OUVRE_JOIN
Local Char    ORDRE_JOI(250)
ORDRE_JOI = "A_TABJ1;A_TABJ2;A_TABJ3;A_TABJ4;A_TABJ5;A_TABJ6;A_TABJ7"
Local Char     A_BUFJ1(5)(1..GNBSEL)
Local Char     A_BUFJ2(20)(1..GNBSEL)
Local Libelle  A_BUFJ3(1..GNBSEL)
Local Char     A_BUFJ4(20)(1..GNBSEL)
Local Integer  A_BUFJ5(1..GNBSEL)
Local Libelle  A_BUFJ6(1..GNBSEL)
Local Integer  A_BUFJ7(1..GNBSEL)
Local Char     A_BUFJ8(15)(1..GNBSEL)
Local Char     A_BUFJ9(80)(1..GNBSEL)
Local File(
& Char     A_TABJ1(5),
& Char     A_TABJ2(20),
& Libelle  A_TABJ3,
& Char     A_TABJ4(20),
& Integer  A_TABJ5,
& Libelle  A_TABJ6,
& Integer  A_TABJ7,
& Char     A_TABJ8(15),
& Char     A_TABJ9(80)
& ) From Variable A_BUFJ1, A_BUFJ2, A_BUFJ3, A_BUFJ4, A_BUFJ5, A_BUFJ6, A_BUFJ7, A_BUFJ8, A_BUFJ9
& As [PCEJ]
Return

$TIT_JOIN
Local Char TITJOI(30)(1..9)
Call TEXTE(1347,TITJOI(1)) From OBJDIV
Call TEXTE(3651,TITJOI(2)) From OBJDIV
Call TEXTE(4969,TITJOI(3)) From OBJDIV
Call TEXTE(7736,TITJOI(4)) From OBJDIV
Call TEXTE(5300,TITJOI(5)) From OBJDIV
Call TEXTE(54136,TITJOI(6)) From OBJDIV
Call TEXTE(5274,TITJOI(7)) From OBJDIV
TITJOI(8) = mess(59,100,1) : # Type
TITJOI(9) = mess(38,100,1) : # Nom
Return

Subprog FORMCLE(FMT,LG,TIT)
Variable Char    FMT()
Variable Integer LG
Variable Char    TIT()
FMT = "Kf:20c"
LG = 0
TIT = ""
End

Subprog FORMCLE2(FMT)
Variable Char    FMT()
FMT = "Kf:5c"
End

$LIENS
Read [SCI]SCI0 = [F:MFC]VCRNUM;[F:MFC]VCRLIN
If fstat : Raz [F:SCI] : Endif
Return

$LIAISONS
Return

Subprog TITTRN(COD,TIT)
Value Char COD
Variable Char TIT
Local Integer OUV
Local Char    CRITERE(250)
TIT = ""
End

$OUVTAB
Return

$OUVVUE
Return

$DEFAUT_TAB
Return

$TRANS_TAB
Return

$TRANS_FIC
Return

$FERME_TAB
Return

$FERME_FIC
Return


