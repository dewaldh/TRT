#<AdxTL>@(#)0.0.0.0 $Revision$
######################################################################################################
# FILE NAME   : YBBBANSEL
# DESCRIPTION : Select Bank Accounts based on FCY Selection
######################################################################################################
# DATE        : 26-09-2018
# AUTHOR      : Dewald Henning
# COMPANY     : Leverage Technologies
#-----------------------------------------------------------------------------------------------------
# Epics Code  : DFCX1-27
#-----------------------------------------------------------------------------------------------------
######################################################################################################
$ACTION
Case ACTION
  When Default
Endcase

Case GACTION
  When "YBBBANSEL"
    Gosub YBBBANSEL
Endcase
Return

$YBBBANSEL
Local Integer I
Local Char TEXTE(255)(1..50,1..4)
Local Char TEX(25)(50)
Local Char REQUEST(255)(0..3)

I=0
TIT(1)="Bank Code"
TIT(2)="Description"
TIT(3)="Company"
TIT(4)="Account"
CRITERE = "1=1"

REQUEST(0) = "Select BAN_0, DES_0, CPY_0, TREACC_0 from BANK WHERE CPY_0 = '"+[M]YCPY+"'"

For (Char BAN(30), Char DES(100), Char CPY, Char ACC) From "5" Sql REQUEST As [YLNK]
  I += 1
  TEX(I)     = [F:YLNK]BAN
  TEXTE(I,1) = [F:YLNK]BAN
  TEXTE(I,2) = [F:YLNK]DES
  TEXTE(I,3) = [F:YLNK]CPY
  TEXTE(I,4) = [F:YLNK]ACC
  If BAN = "" : I = 0 : End : Endif
Next
NBTEX=I

If I <> 0 : [M:YBB1]YACC(nolign-1) = TEXTE(I-1,4) : Endif

If I = 0 Then
  GMESSAGE = mess(15,6254,1)-[M]CPY
  GERR = 1
  mkstat = 2
  zonsui = "[M]YBAN(nolign-1)"
Endif

Return

#Validate entered bank account against company
Subprog VAL_BBBAN(VBAN,VCPY)
Variable Char VBAN()
Variable Char VCPY()
Local Integer I

REQUEST(0) = "Select BAN_0 from BANK WHERE YSTA_0 = 2  and BAN_0 = '"+VBAN+"' and CPY_0 = '"+VCPY+"'"

For (Char BAN(30)) From "5" Sql REQUEST As [YLNK]
  I += 1
  If BAN = "" : I = 0 : End : Endif
Next
NBTEX=I

If I = 0 Then
  GMESSAGE = mess(14,6254,1)
  GERR = 1
  mkstat = 2
  zonsui = "[M]YBAN(nolign-1)"
Endif

End

#Validate Account entered against the Bank account
Subprog VAL_BBANACC(VACC,VBAN)
Variable Char VBAN()
Variable Char VACC()
Local Integer I
Local Char TEXTE(255)(1..50,1..4)

REQUEST(0) = "Select BAN_0 from BANK WHERE YSTA_0 = 2  and BAN_0 = '"+VBAN+"' and TREACC_0 = '"+VACC+"'"

For (Char BAN(30)) From "5" Sql REQUEST As [YLNK]
  I += 1
  TEXTE(I,1) = [F:YLNK]BAN
  If BAN = "" : I = 0 : End : Endif
Next
NBTEX=I

If I <> 0 : [M:YBB1]BAN(nolign-1) = TEXTE(I-1,4) : Endif

End

